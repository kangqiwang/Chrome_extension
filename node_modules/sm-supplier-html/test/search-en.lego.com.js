var should = require('should');
var Structure = require('../lib/structure.js')

describe('replaceWithwebAddress', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://shop.lego.com/en-US/Demolition-Starter-Set-60072"
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Demolition Starter Set",
                    "price": "9.99",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'https://sh-s7-live-s.legocdn.com/is/image/LEGO/60072?$PDPDefault$',
                    "country": 'us',
                    "description": 'Join the demolition experts! The demolition of a derelict building is near completion, and with only a small part of the bathroom remaining it’s time to finish off the job! Operate the powerful jackhammer, swing the heavy sledgehammer, then jump aboard the awesome front loader and scoop up the rubble and remaining debris. What a busy day! Includes 4 minifigures with assorted accessories: 3 demolition workers and a foreman.'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {
        var payload = {
            "pageType" : "product",
            "url" : "https://shop.lego.com/en-US/Spaceport-60080"
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Spaceport",
                    "price": "",
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'https://sh-s7-live-s.legocdn.com/is/image/LEGO/60080?$PDPDefault$',
                    "country": 'us',
                    "description": 'It’s launch day at the LEGO® City Spaceport. Load the satellite into the space shuttle and use the powerful, mobile launchpad to slowly maneuver it to the launch site. Then deliver the astronauts with the service vehicle and get strapped in as countdown commences, 3… 2… 1… liftoff! Feel the power as the main engines ignite and send the shuttle hurtling into space. Eject the external fuel tank and rocket boosters and then open the cargo bay doors ready to launch the satellite! It’s another successful mission for the LEGO City Spaceport! Includes 5 minifigures with assorted accessories: a scientist, 2 service personnel and 2 astronauts.'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://search-en.lego.com/?S1=&cc=US&count=60&i=1&pt=shop&q=city"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": 60,
                    "pages": 4
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "http://search-en.lego.com/?S1=&cc=US&count=60&i=1&pt=shop&q=city"
        }

        // Change to be the number of products on the page
        var x = 60;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = '60073 Service Truck';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '24.99',
                    url: 'http://shop.lego.com/en-US/Service-Truck-60073',
                    image: 'http://cache.lego.com/e/dynamic/is/image/LEGO/60073?$leaf$',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = '4432 Garbage Truck';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: null,
                    url: 'http://shop.lego.com/en-US/Garbage-Truck-4432',
                    image: 'http://cache.lego.com/e/dynamic/is/image/LEGO/4432?$leaf$',
                    country: 'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
