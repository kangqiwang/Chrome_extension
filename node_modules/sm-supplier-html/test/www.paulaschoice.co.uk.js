var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')

describe('replaceWithDomainName', function () {

    this.timeout(5000);

    describe('In Stock Page', function () {

        var payload = {
            "pageType": "product",
            "url": "https://www.paulaschoice.co.uk/resist-anti-aging-skin-revealing-body-lotion-aha-m5900.html?dwvar_m5900_size=fullsize&cgid=body-care#start=0&top=467",
            "html": cache.load("https://www.paulaschoice.co.uk/resist-anti-aging-skin-revealing-body-lotion-aha-m5900.html?dwvar_m5900_size=fullsize&cgid=body-care#start=0&top=467")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function (err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Resist Anti-Aging 10% AHA Body Lotion",
                    "price": "31.00",
                    "url": payload.url,
                    "inStock": 'UNCHECKED',
                    "stockLevel": null,
                    "image": "https://www.paulaschoice.co.uk/on/demandware.static/-/Sites-paulaschoice-catalog/default/dw667c298f/images/5900.png",
                    "country": 'uk',
                    "description": "This creamy, lightweight leave-on exfoliant contains 10% AHA which gently but effectively sheds built-up dead skin cells to reveal smoother, more radiant skin. The gentle lotion also helps to improve the appearance of rough, bumpy skin on the arms and legs leaving skin soft and moisturised."
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function () {

        var payload = {
            "pageType": "product",
            "url": "",
            "html": cache.load("")
        }

        xit('should be false when product is in store only', function (done) {

            Structure(payload, function (err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "",
                    "price": "",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": '',
                    "country": '',
                    "description": ''
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "https://www.paulaschoice.co.uk/body-care",
            "html": cache.load("https://www.paulaschoice.co.uk/body-care")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, category) {
                var expected = JSON.stringify({
                    "name": "Body Care",
                    "url": 'https://www.paulaschoice.co.uk/body-care'
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function () {

                var payload = {
                    "pageType": "pagination",
                    "url": "https://www.paulaschoice.co.uk/body-care",
                    "html": cache.load("https://www.paulaschoice.co.uk/body-care")
                }

                it('should be true when number of items and pages correct', function (done) {

                    Structure(payload, function (err, pagination) {
                        var expected = JSON.stringify({
                            "items": 12,
                            "pages": 2,
                            "url": 'https://www.paulaschoice.co.uk/body-care'
                        })
                        JSON.stringify(pagination).should.equal(expected);
                        done()
                    })
                });

            });


    describe('Search Page', function () {

        var payload = {
            "pageType": "search",
            "url": "https://www.paulaschoice.co.uk/body-care",
            "html": cache.load("https://www.paulaschoice.co.uk/body-care")
        }

        // Change to be the number of products on the page
        var x = 12;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function (err, result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'Daily Replenishing Body Cream';
        it('first product should be ' + firstProductName, function (done) {
            Structure(payload, function (err, result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '23.00',
                    url: 'https://www.paulaschoice.co.uk/daily-replenishing-body-cream-m3450.html?dwvar_m3450_size=fullsize&cgid=body-care',
                    image: 'https://www.paulaschoice.co.uk/dw/image/v2/BBJJ_PRD/on/demandware.static/-/Sites-paulaschoice-catalog/default/dw2d99115b/images/3450.png?sw=460&sh=700&sm=fit',
                    country: 'uk'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'Clinical Body Butter';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function (err, result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '22.00',
                    url: 'https://www.paulaschoice.co.uk/clinical-ultra-rich-soothing-body-butter-m5560.html?dwvar_m5560_size=fullsize&cgid=body-care',
                    image: 'https://www.paulaschoice.co.uk/dw/image/v2/BBJJ_PRD/on/demandware.static/-/Sites-paulaschoice-catalog/default/dw10df3b6f/images/5560.png?sw=460&sh=700&sm=fit',
                    country: 'uk'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});


