var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')

describe('www.allegromedical.com', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.allegromedical.com/diabetic-supplies-c520/onetouch-ultra-diabetic-test-strips-blue-p189484.html",
            "html": cache.load("https://www.allegromedical.com/diabetic-supplies-c520/onetouch-ultra-diabetic-test-strips-blue-p189484.html")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(error,inStockPage) {
                var expected = JSON.stringify({
                    "name": "OneTouch Ultra Diabetic Test Strips - Blue - Glucose Test Strips",
                    "price": "223.73",
                    "url": 'https://www.allegromedical.com/diabetic-supplies-c520/onetouch-ultra-diabetic-test-strips-blue-p189484.html',
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'https://www.allegromedical.com/images/productImages/86/27/onetouch-ultra-diabetic-test-strips-blue-189484-MEDIUM_0.jpg',
                    "country": 'us',
                    "description": "OneTouch Ultra Blue Test Strips The OneTouch Ultra Test Strips with FastDraw Design make blood glucose testing fast, easy, and less painful for anyone with diabetes. The One Touch Ultra Meter gives results in just 5 seconds and requires just a speck of blood. That can mean less pain when you test on your fingers or forearm. Just touch the end of the test strip to your blood sample. The test strip automatically draws up blood and makes it easy to see when there's enough blood for an accurate reading. OneTouch Ultra Blue Test Strips can be used with any : One Touch Ultra2 One Touch Ultra One Touch UltraSmart InDuo Meters OneTouch UltraMini OneTouch UltraLink OneTouch Ultra Test Strips Product Features: Results in just 5 seconds Requires just a speck of blood Automatically draws blood into the test strip and makes it easy to see when there's blood enough for an accurate reading For testing outside the body (in vitro diagnostic use). Read package insert before using this product. Refer to your OneTouch® Owner's Booklet for detailed instructions on testing your blood. Intended Use OneTouch® Ultra® Test Strips are used with the OneTouch® Ultra® Family of Meters and InDuo® Systems for quantitatively measuring glucose in fresh capillary whole blood. The OneTouch® Ultra® Test Strips and the associated meters are intended for use outside the body (in vitro diagnostic use) by people with diabetes at home and healthcare professionals in the clinical setting, as an aid to monitor the effectiveness of diabetes control. OneTouch® Ultra® Test Strips and associated meters are for use on the finger, palm, and forearm. Storage and Handling Store the test strip package in a cool dry place not above 86° F (30° C). Do not refrigerate. Keep away from direct sunlight and heat. Exposure to temperatures and/or humidity outside the required storage conditions may result in inaccurate readings. Store your test strips in their original vial only. To avoid damage or contamination, do not transfer test strips to any other place. After removing a OneTouch® Ultra® Test Strip from the vial, immediately replace the vial cap and close it tightly. Use each test strip immediately after removing it from the vial. Do not use test strips from any vial that is damaged or left open to air. Write the discard date (3 months after first opening the vial) on the vial label when you first open it. Discard remaining OneTouch® Ultra® Test Strips after the discard date. Do not use test strips beyond the expiration (printed on package) or discard date, whichever comes first, because they may cause inaccurate results. Avoid getting dirt, food or liquids on the test strip. With clean, dry hands, you may touch the test strip anywhere on its surface. Do not bend, cut, or alter a OneTouch® Ultra® Test Strip in any way. OneTouch® Ultra® Test Strips are for single use only. Never reuse a test strip that had either blood or control solution applied to it. Apply only OneTouch® Ultra® Control Solution or a blood sample to the test strip. Testing with the OneTouch Ultra Test Strips allows for faster and less painful testing. 020244 - 1 Box of 50 - Box of 50 - $118.79 ($2.38 per unit) D1UL-NFR050 x 2 - 2 Boxes of 50 - Box of 100 - $223.73 ($2.24 per unit)"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    xdescribe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.allegromedical.com/diabetic-supplies-c520/easy-touch-insulin-pen-needles-p565047.html",
            "html": cache.load("http://www.allegromedical.com/diabetic-supplies-c520/easy-touch-insulin-pen-needles-p565047.html")
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(err,inStockPage) {
                var expected = JSON.stringify({
                    "name": "Easy Touch Insulin Pen Needles",
                    "price": "13.60",
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'http://imgorigin.allegromedical.com/1D/7C/easy-touch-insulin-pen-needles-565047-MEDIUM_0.jpg',
                    "country": 'us',
                    "description": "EasyTouch® U100 Insulin Pen Needles Temporarily Unavailable - Please see substitute HTL-Strefa Droplet Pen NeedleAllegro ID 574678 EasyTouch® Pen Needles feature comfort you can feel. Surgical steel, electro-polished to remove burrs, triple-bevel sharp point and a long tapered tip are high quality features in an affordable pen needle. Film coating provides a smoother injection to optimize comfort. The following insulin pen delivery devices are compatible with the EasyTouch Pen Needles: BD® Pen Flexpen® Humalog® Pen Humulin® Pen InDuo® Innolet® Innovo® NOVOPen® Junior NOVOPen® 3ml Sizes Available 29g 1/2\" 31g 5/16\", 1/4\", 3/16\" 32g 1/4\", 3/16\" Packaging Individually packaged 100 Pen Needles Per Box 12 Boxes Per Case 832041 - 32g 1/4\" - $13.60 ($0.14 per unit) EZ832361 - 32g 3/16\" - $13.61 ($0.14 per unit)"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "https://www.allegromedical.com/personal-care-c532/compression-socks-c3704.html",
            "html": cache.load("https://www.allegromedical.com/personal-care-c532/compression-socks-c3704.html")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err,pagination) {
                var expected = JSON.stringify({
                    "items": 24,
                    "pages": 3,
                    "url":'https://www.allegromedical.com/personal-care-c532/compression-socks-c3704.html'
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "https://www.allegromedical.com/personal-care-c532/compression-socks-c3704.html",
            "html": cache.load("https://www.allegromedical.com/personal-care-c532/compression-socks-c3704.html")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err,category) {
                var expected = JSON.stringify({
                    "name": "Compression Socks",
                    "url":'https://www.allegromedical.com/personal-care-c532/compression-socks-c3704.html'

                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });


    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.allegromedical.com/personal-care-c532/compression-socks-c3704.html",
            "html": cache.load("https://www.allegromedical.com/personal-care-c532/compression-socks-c3704.html")
        }

        // Change to be the number of products on the page
        var x = 13;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(err,result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'Medicore Copper Compression Socks for Men and Women';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(err,result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '32.62',
                    url: 'http://www.allegromedical.com/personal-care-c532/medicore-copper-compression-socks-for-men-and-women-p565897.html',
                    image: 'https://www.allegromedical.com/images/productImages/8C/0D/medicore-copper-compression-socks-for-men-and-women-565897-SMALL_0.jpg',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'CURAD Cushioned Compression Socks';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(err,result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '25.60',
                    url: 'http://www.allegromedical.com/personal-care-c532/curad-cushioned-compression-socks-p574443.html',
                    image: 'https://www.allegromedical.com/images/productImages/D7/DC/curad-cushioned-compression-socks-574443-SMALL_0.jpg',
                    country: 'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
