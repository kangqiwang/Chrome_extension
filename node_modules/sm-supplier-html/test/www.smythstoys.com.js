var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')

describe('www.smythstoys.com', function() {

    before(function()  {
        this.timeout(5000);
    })


    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.smythstoys.com/uk/en-gb/toys/action-figures-and-playsets/power-rangers/c/SM06010113",
            "html" : cache.load("https://www.smythstoys.com/uk/en-gb/toys/action-figures-and-playsets/power-rangers/c/SM06010113")
        }

        it('should return 59 products', function (done) {
            Structure(payload, function(err, result) {
                result.length.should.equal(59);
                done()
            })
        });

       
        it('first product should be ', function (done) {
            Structure(payload, function(err, result) {
                var last = result.shift()
                last.name.should.be.equal('Power Rangers Legacy Red Ranger Power Sword')
                last.price.should.be.equal('99.99')
                last.url.should.be.equal('https://www.smythstoys.com/uk/en-gb/toys/action-figures-and-playsets/power-rangers/power-rangers-legacy-red-ranger-power-sword/p/161916')
                last.image.should.be.equal('https://image.smythstoys.com/picture/desktop/161916.jpg')
                last.country.should.be.equal('uk')
                should(last.barcode).be.equal(null)
                last.sku.should.be.equal('161916')
                done()
            });
        })

        it('last product should be ', function (done) {
            Structure(payload, function(err, result) {
                var last = result.pop()
                last.name.should.be.equal('PR Legacy Auto Morphin Red Ranger')
                last.price.should.be.equal('24.99')
                last.url.should.be.equal('https://www.smythstoys.com/uk/en-gb/toys/action-figures-and-playsets/power-rangers/pr-legacy-auto-morphin-red-ranger/p/167933002')
                last.image.should.be.equal('https://image.smythstoys.com/picture/desktop/167933002.jpg')
                last.country.should.be.equal('uk')
                should(last.barcode).be.equal(null)
                last.sku.should.be.equal('167933002')
                done()
            });
        })


    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.smythstoys.com/uk/en-gb/toys/c-766/lego-bricks/",
            "html" : cache.load("http://www.smythstoys.com/uk/en-gb/toys/c-766/lego-bricks/")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": 180,
                    "pages": 3,
                    "url" : "http://www.smythstoys.com/uk/en-gb/toys/c-766/lego-bricks/",
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "https://www.smythstoys.com/uk/en-gb/toys/action-figures-and-playsets/avengers/c/SM06010101",
            "html" : cache.load("http://www.shop4world.com/torches/2aa-splashproof-soft-touch-rubber-torch-blue")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, category) {
                var expected = JSON.stringify({
                    "name": "",
                    "url" : "https://www.smythstoys.com/uk/en-gb/toys/action-figures-and-playsets/avengers/c/SM06010101"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.smythstoys.com/uk/en-gb/toys/action-figures-and-playsets/power-rangers/fisher-price-imaginext-morphin-megazord-power-rangers-71cm/p/144790",
            "html" : cache.load("https://www.smythstoys.com/uk/en-gb/toys/action-figures-and-playsets/power-rangers/fisher-price-imaginext-morphin-megazord-power-rangers-71cm/p/144790")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Fisher-Price Imaginext Morphin Megazord Power Rangers 71cm",
                    "price": "44.99",
                    "url": payload.url,
                    "inStock": true,
                    "stockLevel": null,
                    "image": "https://image.smythstoys.com/original/desktop/144790_9.jpg",
                    "country": "uk",
                    "sku": '144790'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.smythstoys.com/uk/en-gb/video-games-and-tablets/nintendo-switch/nintendo-switch-games/fire-emblem-warriors-nintendo-switch/p/161564",
            "html" : cache.load("https://www.smythstoys.com/uk/en-gb/video-games-and-tablets/nintendo-switch/nintendo-switch-games/fire-emblem-warriors-nintendo-switch/p/161564")
        }

        it('should return false when product is out of stock', function(done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Fire Emblem Warriors Nintendo Switch",
                    "price": "30.00",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": "https://image.smythstoys.com/original/desktop/161564_2.jpg",
                    "country": "uk",
                    "sku": '161564'
              })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        })

    })

    describe('Checking to see if no pagination works', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.smythstoys.com/uk/en-gb/page/o/customerservice/faq/",
            "html" : cache.load("http://www.smythstoys.com/uk/en-gb/page/o/customerservice/faq/")
        }

        it('should return null items and null pages', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": null,
                    "pages": null,
                    "url" : "http://www.smythstoys.com/uk/en-gb/page/o/customerservice/faq/"
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

});
