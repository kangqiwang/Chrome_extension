var should = require('should');
var Structure = require('../lib/structure.js')

describe('www.ems.com', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.ems.com/the-north-face-women%E2%80%99s-highanddry-triclimate-jacket/2008691.html"
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "THE NORTH FACE Women’s Highanddry Triclimate Jacket",
                    "price": "260.00",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'http://www.ems.com/on/demandware.static/-/Sites-vestis-master-catalog/default/dwaa34c6ee/product/images/2008/691/2008691/2008691_001_main.jpg',
                    "country": 'us',
                    "description": 'When you predict wet weather or colder climates along the trails, have a jacket that lets you adapt without ever being too bulky or offering insufficient coverage. With a three-in-one design, this solution from The North Face blocks out the elements with a waterproof, lightly insulated shell and holds onto body heat with a mid-weight fleece liner. Together, they stretch for optimal movement and keep you warm and dry, and alone, they offer enough for handling cool or damp environments. Made out of DryVent™ 2L, a 100% polyester material with a multi-part polyurethane coating designed to repel water and improve strength Insulated with 60g Heatseeker™ Taffeta lining Inner layer is made out of a 95% polyester/5% elastane heathered smooth-face Agave fleece blend Brushed back liner for a softer feel With a removable, adjustable hood Zippers at center front and hand pockets Outer includes a secure-zip internal chest pocket, Velcro® adjustable cuffs, and a cinch-cord hem Inner has zippered hand pockets Weighs 33.51 oz. Imported'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.ems.com/kryptonite-key-lock/26868200015.html"
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "KRYPTONITE Key Lock",
                    "price": "6.98",
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'http://www.ems.com/on/demandware.static/-/Sites-vestis-master-catalog/default/dwcda645dd/product/images/1301/238/1301238/1301238_915_main.jpg',
                    "country": 'us',
                    "description": 'This laminated steel key lock from Kryptonite measures 1.7 inches across and is 0.6 inches thick. Double deadbolt locking for maximum security Plated, laminated steel body for all weather performance Case hardened steel shackle resists attacks Stainless steel springs and 5 brass pins'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.ems.com/women/womens-jackets/insulated-jackets/#sz=60"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": 60,
                    "pages": 3
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

     describe('Not a search page', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.ems.com/mountain-hardwear-women%E2%80%99s-switch-flip-jacket/2010579.html"
        }

        it('should return null items and pages', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": null,
                    "pages": null
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "http://www.ems.com/women/womens-jackets/insulated-jackets/#sz=60"
        }

        it('should be true when correct category is returned', function (done) {

            Structure(payload, function(category) {
                var expected = JSON.stringify({
                    "name": "Women's Insulated Jackets"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "http://www.ems.com/women/womens-jackets/insulated-jackets/#sz=60"
        }

        // Change to be the number of products on the page
        var x = 60;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'THE NORTH FACE Women’s Thermoball™ Full Zip Jacket';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '199.00',
                    url: 'http://www.ems.com/the-north-face-women%E2%80%99s-thermoball-full-zip-jacket/1285544.html',
                    image: 'http://www.ems.com/dw/image/v2/AAQU_PRD/on/demandware.static/-/Sites-vestis-master-catalog/default/dw4ff5ce6a/product/images/1285/544/1285544/1285544_001_main.jpg?sw=195&sh=195&sm=fit',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'WOOLRICH Women’s Patrol Down Parka';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '495.00',
                    url: 'http://www.ems.com/woolrich-women%E2%80%99s-patrol-down-parka/2023043.html',
                    image: 'http://www.ems.com/dw/image/v2/AAQU_PRD/on/demandware.static/-/Sites-vestis-master-catalog/default/dw3a9e07b2/product/images/2023/043/2023043/2023043_001_main.jpg?sw=195&sh=195&sm=fit',
                    country: 'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
