var should = require('should');
var Structure = require('../lib/structure.js')
var cache = require('../lib/cache')


describe('www.jcpenney.com', function() {

    before(function()  {
        this.timeout(5000); 
    })

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.jcpenney.com/p/r-m-richards-3-4-sleeve-lace-jacket-dress/ppr5007458611?pTmplType=regular&productGridView=medium&selectedSKUId=22951730174&badge=fewleft&jl_ctx=on_site",
            "html": cache.load('https://www.jcpenney.com/p/r-m-richards-3-4-sleeve-lace-jacket-dress/ppr5007458611?pTmplType=regular&productGridView=medium&selectedSKUId=22951730174&badge=fewleft&jl_ctx=on_site')
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "R & M Richards 3/4 Sleeve Lace Jacket Dress",
                    "price": "69.99",
                    "url": payload.url,
                    "inStock": true,
                    "stockLevel": null,
                    "image": "https://s7d9.scene7.com/is/image/JCPenney/DP0117201817140519M?resmode=sharp2&op_sharpen=1&wid=550&hei=550",
                    "country": "us"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    
    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.jcpenney.com/p/jcpenney-home-325tc-cotton-sheet-set/pp5006960610?pTmplType=regular&catId=cat1005020007&deptId=dept20000011&urlState=/g/jcpenney-home-linens-blue/N-bwo3vDgmd2efZ180Z12y&page=3&badge=fewleft%7Ccollection&selectedSKUId=72308020059&facetSelected=color&color=blue",
            "html": cache.load('https://www.jcpenney.com/p/jcpenney-home-325tc-cotton-sheet-set/pp5006960610?pTmplType=regular&catId=cat1005020007&deptId=dept20000011&urlState=/g/jcpenney-home-linens-blue/N-bwo3vDgmd2efZ180Z12y&page=3&badge=fewleft%7Ccollection&selectedSKUId=72308020059&facetSelected=color&color=blue')
        }
            
        it('should return false when product is out of stock', function(done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "JCPenney Homeâ„¢ 325tc Cotton Sheet Set",
                    "price": "23.99",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": "https://s7d9.scene7.com/is/image/JCPenney/DP1213201620350941C?hei=550&wid=550&op_usm=.4%2C.8%2C0%2C0&resmode=sharp2&op_sharpen=1",
                    "country": "us"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
           })
        })
    })


    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.jcpenney.com/g/womens-dresses/N-bwo3xD1nnujc?cm_re=ZB-_-LF-_-Womens_ShopClothing_Dresses%7C1%7C",
            "html": cache.load('https://www.jcpenney.com/g/womens-dresses/N-bwo3xD1nnujc?cm_re=ZB-_-LF-_-Womens_ShopClothing_Dresses%7C1%7C')
        } 

        var x = 45
        it('should return ' + x + ' number of products', function (done) {
            Structure(payload, function(err, result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'R & M Richards 3/4 Sleeve Lace Jacket Dress'
        it('last product should be ' + firstProductName, function (done) {
            Structure(payload, function(err, result) {
                var last = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '59.49', 
                    url: 'https://www.jcpenney.com/p/r-m-richards-3-4-sleeve-lace-jacket-dress/ppr5007458611?pTmplType=regular&productGridView=medium&selectedSKUId=22951730174&badge=fewleft&jl_ctx=on_site',
                    image: 'https://s7d4.scene7.com/is/image/JCPenney/DP0117201817140519M.tif?wid=350&hei=350&op_usm=.4,.8,0,0&resmode=sharp2',
                    country:'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

        var lastProductName = 'Maya Brooke 3/4 Sleeve Embroidered Jacket Dress'
        it('first product should be ' + lastProductName, function(done) {
            Structure(payload, function(err, result) {
                var first = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '56.09', 
                    url: 'https://www.jcpenney.com/p/maya-brooke-3-4-sleeve-embroidered-jacket-dress/ppr5007607851?pTmplType=regular&productGridView=medium&selectedSKUId=22952680067&badge=fewleft&jl_ctx=on_site',
                    image: 'https://s7d4.scene7.com/is/image/JCPenney/DP0118201811130508M.tif?wid=350&hei=350&op_usm=.4,.8,0,0&resmode=sharp2',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

    });


    // describe('Search page pagination', function() {

    //     var payload = {
    //         "pageType" : "pagination",
    //         "url" : "http://www.jcpenney.com/g/quilts-bedspreads/N-bwo3wD1nqf4p?cmJCP_T=G1&cmJCP_C=D2"
    //     }

    //     it('should be true when number of items and pages correct', function (done) {

    //         Structure(payload, function(pagination) {
    //             var expected = JSON.stringify({
    //                 "items": 72,
    //                 "pages": 10
    //             })
    //             JSON.stringify(pagination).should.equal(expected);
    //             done()
    //         })
    //     });

    // })

    // describe('Checking to see if no pgination works', function() {

    //     var payload = {
    //         "pageType" : "pagination",
    //         "url" : "http://www.jcpenney.com/g/quilts-bedspreads/N-bwo3wD1nqf4pZ1z13kmh?cm_re=S3-_-VN-_-QUILTS_BEDSPREADS"
    //     }

    //     it('should return 0/null items and null pages', function (done) {

    //         Structure(payload, function(pagination) {
    //             var expected = JSON.stringify({
    //                 "items": null,
    //                 "pages": null
    //             })
    //             JSON.stringify(pagination).should.equal(expected);
    //             done()
    //         })
    //     });

    // });

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "https://www.jcpenney.com/g/womens-dresses/N-bwo3xD1nnujc?cm_re=ZB-_-LF-_-Womens_ShopClothing_Dresses%7C1%7C",
            "html": cache.load('https://www.jcpenney.com/g/womens-dresses/N-bwo3xD1nnujc?cm_re=ZB-_-LF-_-Womens_ShopClothing_Dresses%7C1%7C')
        }

        it('should be true when correct category is returned', function (done) {

            Structure(payload, function(err, category) {
                var expected = JSON.stringify({
                    "name": "women's dresses",
                    "url": payload.url,
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

});
