var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')

describe('www.gooutdoors.co.uk', function() {

    before(function()  {
        this.timeout(5000);
    })

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.gooutdoors.co.uk/three-section-carp-mat-p216609",
            "html": cache.load("http://www.gooutdoors.co.uk/three-section-carp-mat-p216609")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Westlake Three Section Carp Mat",
                    "price": "4.99", 
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": "www.gooutdoors.co.uk/ZoomProductImages.aspx?ProductId=216609&ProductImageId=23690&W=835&H=805",
                    "country": "uk",
                    "description": "Simple unhooking mat to protect your landed fish.The Westlake Three Section Carp Mat offers excellent value for money and is a useful and practical accessory for your fishing trip.Foam padded with a D-ring at each end to peg it down securely, the lightweight fold up design has 2 elasticated loops to secure it closed for transport. Conforms to the regulations of most commercial fisheries. Unfolded size 88 x 50 x 2cm, folded size 26 x 50 x 6cm"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.gooutdoors.co.uk/edelrid-liner-rope-bag-p194168",
            "html": cache.load("http://www.gooutdoors.co.uk/edelrid-liner-rope-bag-p194168")
        }

        it('should return false when product is out of stock', function(done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Edelrid Liner Rope Bag",
                    "price": "12.00", 
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": "www.gooutdoors.co.uk/ZoomProductImages.aspx?ProductId=194168&ProductImageId=20123&W=1323&H=655",
                    "country": "uk",
                    "description": "A simple yet well designed rope bagBetter protect and manage your rope with the Edelrid Liner combination rope bag and mat. With twin tie-in loops for your rope ends, twin closure buckles and simple roll away, shoulder carry design, packing, unpacking and transporting your rope has never been easier."
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        })

    })

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "http://www.gooutdoors.co.uk/camping/tents",
            "html": cache.load("http://www.gooutdoors.co.uk/camping/tents")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, category) {
                var expected = JSON.stringify({
                    "name": "Tents"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "http://www.gooutdoors.co.uk/skiing/clothing/baselayers",
            "html": cache.load("http://www.gooutdoors.co.uk/skiing/clothing/baselayers")
        }

        // Change to be the number of products on the page
        var x = 24;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(err, result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'OEX Bandicoot II 2 Man Semi-Geodesic Tent';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(err, result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '90.00',
                    url: 'www.gooutdoors.co.uk/oex-bandicoot-ii-2-man-semi-geodesic-tent-p360611',
                    image: 'http://defd230db96761500ca7-61c6d5aeae250d28854ed3e240a16b15.r17.cf3.rackcdn.com/Products/48273-220216113018532635040.jpg',
                    country: 'uk'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'Vango Mirage 300 Tent';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(err, result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '169.99',
                    url: 'www.gooutdoors.co.uk/vango-mirage-300-tent-p367467',
                    image: 'http://defd230db96761500ca7-61c6d5aeae250d28854ed3e240a16b15.r17.cf3.rackcdn.com/Products/45329-0511151111131973763845.jpg',
                    country: 'uk'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
