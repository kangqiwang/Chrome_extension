const ProductModel = require('./model/product');
const SupplierModel = require('./model/supplier');


const config = require('./config');
const async = require('async');

let createIndexes = (country, next) => {
    console.log('Creating indexes:');

    let Supplier = new SupplierModel(config.mongoDb, {
        country: country
    });

    let product = new ProductModel(config.es, country);

    Supplier.find({}, (err, supplierList) => {

        let supplierIndex = []
        supplierList.records.map((supplier) => {
            supplierIndex.push(country + '-' + supplier.domain.replace(/\./g, '-').split('/')[0].trim());
        })

        async.eachSeries(supplierIndex, (index, done) => {
            product.createIndex(index, 'supplierMapping', (err) => {
                console.log(new Date().toISOString() + ' ' + index);
                if (err) {
                    console.log(err);
                }
                done();
            });
        }, next);
    });
};


let createSingleIndex = (country, domain, next) => {
    console.log('Creating indexes: ', domain);

    let Supplier = new SupplierModel(config.mongoDb, {
        country: country
    });

    let product = new ProductModel(config.es, country);

    let index = country + '-' + domain.replace(/\./g, '-').split('/')[0].trim()

    product.createIndex(index, 'supplierMapping', (err) => {
        console.log(new Date().toISOString() + ' ' + index);
        if (err) {
            console.log(err);
        }
        next();
    });

};

let createAmazon = (country, next) => {
    let product = new ProductModel(config.es, country);
    let index = country === 'us' ? 'us-www-amazon-com' : 'uk-www-amazon-co-uk';
    product.createIndex(index, 'amazonMapping', (err) => {
        console.log(new Date().toISOString() + ' ' + index);
        if (err) {
            console.log(err);
        }
        next();
    });
};

if (!process.argv[2]) {
    async.series([
        function doUK(done) {
            createIndexes('uk', done);
        },
        function doUS(done) {
            createIndexes('us', done);
        },
        function doAmazon(done) {
            createAmazon('uk', () => {
                createAmazon('us', done);
            });
        }
    ], () => {
        process.exit();
    });
} else {
    createSingleIndex(process.argv[2],process.argv[3],()=>{
        process.exit();
    })
}

