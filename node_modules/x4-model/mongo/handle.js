var MongoClient = require('mongodb').MongoClient;
var md5 = require('md5');
var hdl = {};

const isHandle = (dbId, next) => {
	if(hdl[dbId] !== true && hdl[dbId] !== false) {
		next(null, hdl[dbId])
	} else {
		setTimeout(() => {
			isHandle(dbId, next)
		}, 100)
	}
}

const connect = (config, next) => {	

	var url = 'mongodb://' + config.host + ':' + config.port + '/' + config.db;
	if(config.url)  {
		url = config.url
	}

	let dbId = md5(url);
	
	if(hdl[dbId] === undefined) {
		hdl[dbId] = true
	}

	if(hdl[dbId] === true) {
	
		hdl[dbId] = false
		console.log(dbId, url)		
		MongoClient.connect(url, {
			reconnectTries: 3600,
			reconnectInterval: 500,
			autoReconnect: true
		}, function (err, db) {
			if(err) {
				console.error(url + ' ' + err.toString())
				setTimeout(() => {
					connect(config, next)
				}, 2000)
			} else {				
				hdl[dbId] = db;
				next(err, db);
			}

		});
	} else {
		isHandle(dbId, next)
	}

}

module.exports = function (config, next) {
	connect(config, next);
};