var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')

describe('www.currentcatalog.com', function () {


    xdescribe('In stock Page', function () {

        var payload = {
            "pageType": "product",
            "url": "https://www.currentcatalog.com/buy/personalized-grateful-thankful-blessed-mug.html",
            "html": cache.load("https://www.currentcatalog.com/buy/personalized-grateful-thankful-blessed-mug.html")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function (err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Personalized Grateful, Thankful, Blessed Mug",
                    "price": "12.99",
                    "url": payload.url,
                    "inStock": true,
                    "stockLevel": null,
                    "image": "https://images.currentcatalog.com/catalog/product/450x450/616649/616649.jpg",
                    "country": "us"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    xdescribe('Out of Stock Page', function () {

        var payload = {
            "pageType": "product",
            "url": "https://www.currentcatalog.com/buy/music-notes-file-folders-614492.html",
            "html": cache.load("https://www.currentcatalog.com/buy/music-notes-file-folders-614492.html")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function (err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Music Notes File Folders",
                    "price": "4.99",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": "https://images.currentcatalog.com/catalog/product/450x450/614492/music-notes-file-folders.jpg",
                    "country": "us"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });
})

describe('Search Page', function () {

    var payload = {
        "pageType": "search",
        "url": "https://www.currentcatalog.com/gifts/best-gifts/personalized-mugs.html",
        "html": cache.load("https://www.currentcatalog.com/gifts/best-gifts/personalized-mugs.html")
    }

    // Change to be the number of products on the page
    var x = 22;
    it('should return ' + x + ' numer of products', function () {
        let result = Structure(payload)
        result.length.should.equal(x);
    });

    var firstProductName = 'Marley Pug Pop Over Phone Case';
    it('first product should be ' + firstProductName, function() {

        var expected = JSON.stringify({
            barcode: null,
            name: firstProductName,
            price: '4.80',
            url: 'https://www.claires.com/marley-pug-pop-over-phone-case-229291M.html?cgid=168&lang=en_GB',
            image: 'https://www.claires.com/dw/image/v2/BBTK_PRD/on/demandware.static/-/Sites-master-catalog/default/dw3b322a6b/images/hi-res/98823_1.jpg?sw=290&sh=290&sm=fit',
            country: 'us'
        })
        
        let result = Structure(payload)

        var first = result.shift()
        
        JSON.stringify(first).should.equal(expected)

    })

    var lastProductName = 'Rainbow Marble with Gold Foil Flakes Phone Case';
    it('last product should be ' + lastProductName, function () {
        var expected = JSON.stringify({
            barcode: null,
            name: lastProductName,
            price: '4.80',
            url: 'https://www.claires.com/rainbow-marble-with-gold-foil-flakes-phone-case-230461.html?cgid=168&lang=en_GB',
            image: 'https://www.claires.com/dw/image/v2/BBTK_PRD/on/demandware.static/-/Sites-master-catalog/default/dw7ad4ce93/images/hi-res/23509_1.jpg?sw=290&sh=290&sm=fit',
            country: 'us'
        })

        const result = Structure(payload);

        var last = result.pop()
        JSON.stringify(last).should.equal(expected)
    })

}); 


    describe('Search page category', function () {

        var payload = {
            "pageType": "category",
            "url": "https://www.currentcatalog.com/gifts/best-gifts/personalized-mugs.html",
            "html": cache.load("https://www.currentcatalog.com/gifts/best-gifts/personalized-mugs.html")
        }

        it('should be true when the category is correct', function (done) {

            Structure(payload, function (err, category) {
                var expected = JSON.stringify({
                    "name": "Coffee Mugs",
                    "url": payload.url 
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

