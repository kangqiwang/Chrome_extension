var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')


describe('www.itechdeals.com', function() {
    
    this.timeout(5000);

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.itechdeals.com/chargers-cables.html",
            "html" : cache.load("https://www.itechdeals.com/chargers-cables.html")
        }

        it('should return 12 products', function (done) {
            Structure(payload, function(err, result) {
                result.length.should.equal(12);
                done()
            })
        });

        it('last product should be', function (done) {
            Structure(payload, function(err, result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: '5 Pack: 8-Pin to Micro USB Adapter for iPad & iPhone 5/6/7/8',
                    price: '7.99',
                    url: 'https://www.itechdeals.com/5-pack-8-pin-to-micro-usb-adapter-free-shipping.html',
                    image: 'https://www.itechdeals.com/media/catalog/product/cache/1/small_image/295x295/9df78eab33525d08d6e5fb8d27136e95/8/p/8pinusb5.jpg',
                    country: 'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

        it('first product should be', function(done) {
            Structure(payload, function(err, result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: '8 Pin to USB Charge & Data Sync Cables for iPhone (White)',
                    price: '1.00',
                    url: 'https://www.itechdeals.com/8-pin-to-usb-cable-charge-and-data-sync-cable-for-apple-iphone-and-ipad.html',
                    image: 'https://www.itechdeals.com/media/catalog/product/cache/1/small_image/295x295/9df78eab33525d08d6e5fb8d27136e95/l/i/lightning-usb-data-cable-for-iphone-5-and-ipad-mini-10ft-3m-1_5.jpg',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

    });


    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.itechdeals.com/camera.html",
            "html" : cache.load("http://www.itechdeals.com/camera.html")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": 36,
                    "pages": 3,
                    "url":"http://www.itechdeals.com/camera.html"
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Checking to see if no pgination works', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.itechdeals.com/camera/selfie-sticks-and-remotes.html",
            "html" : cache.load("http://www.itechdeals.com/camera/selfie-sticks-and-remotes.html")
        }

        it('should return 0/null items and null pages', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": 36,
                    "pages": null,
                    "url": "http://www.itechdeals.com/camera/selfie-sticks-and-remotes.html"
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "http://www.itechdeals.com/camera.html",
            "html" : cache.load("http://www.itechdeals.com/camera.html")
        }

        it('should be true when correct category is returned', function (done) {

            Structure(payload, function(err, category) {
                var expected = JSON.stringify({
                    "name": "Camera",
                    "url":"http://www.itechdeals.com/camera.html"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.itechdeals.com/audio/speakers/wireless-speakers/mini-portable-subwoofer-wireless-waterproof-bluetooth-speaker.html",
            "html" : cache.load("https://www.itechdeals.com/audio/speakers/wireless-speakers/mini-portable-subwoofer-wireless-waterproof-bluetooth-speaker.html")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Waterproof Bluetooth Shower Speaker",
                    "price": "9.99",
                    "url": payload.url,
                    "inStock": true,
                    "stockLevel": null,
                    "image": "https://www.itechdeals.com/media/catalog/product/cache/1/image/650x650/9df78eab33525d08d6e5fb8d27136e95/a/q/aquasound-water-resistant-bluetooth-speaker-for-bathroom-and-shower-black.jpg",
                    "country": "us",
                    "description": "There's something about listening to music while taking a shower that makes the experience much more enjoyable. This Waterproof Wireless Bluetooth Shower Speaker & Hands Free Speakerphone will give you a kick-start and allow you the chance to rock out while getting squeaky clean. It also connects to Bluetooth-enabled smartphones, headsets, tablets, computers,and more! With this amazing speaker you will be able to stream and share music, movies, and games from anywhere you please. You can even bring it on the road with you, talk about convenient! Grab this dealtoday and be one step closer to enjoying all the benefits of hands free entertainment! 100% Brand New and High Quality Stereo Audio OutputCan be use as a waterproof speaker in the shower roomDo not drop the speaker into the waterBuilt-in Microphone, very convenient to useYou can enjoy hands-free phone calls and music in the car making your driving or trip more elegant and safeStick it to your smartphone or tablet with its suction cupConvenient buttons for music and call control while in the shower, at the pool, or in the carIncredible soundGreat highs and lows make it perfect for a home audio systemGreat suction cup attached that will grab on to any flat surface! Shower, door, window, etc.Long lasting Battery life (6 hours) lets you use it in several showers on a single chargeIPx4 Rated Waterproof meaning you can get as much water as you want on it and it will still work JUST as wellSpecification:Wireless Technology: Bluetooth 3.0 + EDRTransmitting Frequency: 2.4G HzTransfer Range: 10M (the distance depends on thebluetooth device and environment)Power Supply: DC 5V/ 100-120mAOutput: 3WBattery: 3.7V 400mAh lithiumCharging Time: 3 hoursIPx4 Grade WaterproofColor:Blue /Rose /Green/Yellow / Black / WhiteDimenisons: 3.5x 2.0 inch (Dia. x H) 1 x Waterproof Bluetooth Speaker 1 x USB Charge Cable 1 x User Manual *Item Condition: New *Item condition: New 1 x Waterproof Bluetooth Speaker 1 x USB Charge Cable 1 x User Manual *Item Condition: New"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });


    // describe('Out of Stock Page', function() {

    //     var payload = {
    //         "pageType" : "product",
    //         "url" : ""
    //     }
            
    //     it('should return false when product is out of stock', function(done) {

    //         Structure(payload, function(inStockPage) {
    //             var expected = JSON.stringify({
    //                 "name": "",
    //                 "price": "",
    //                 "url": null,
    //                 "inStock": false,
    //                 "stockLevel": null,
    //                 "image": "",
    //                 "country": ""
    //             })
    //             JSON.stringify(inStockPage).should.equal(expected);
    //             done()
    //         })
    //     })

    // })

});
