var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')

describe('replaceWithwebAddress', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.flexxmemory.co.uk/mac-ddr3-1600mhz/16gb-kit-2-x-8gb-204-pin-sodimm-ddr3-pc3l-12800-memory-module-for-mac-ct2c8g3s160bmceu/",
            "html" :cache.load("http://www.flexxmemory.co.uk/mac-ddr3-1600mhz/16gb-kit-2-x-8gb-204-pin-sodimm-ddr3-pc3l-12800-memory-module-for-mac-ct2c8g3s160bmceu/")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "16GB Kit ( 2 x 8GB ), 204-pin SODIMM, DDR3 PC3L-12800 memory module ( for Mac ), CT2C8G3S160BMCEU",
                    "price": "99.99",
                    "url": payload.url,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'http://cdn2.bigcommerce.com/server5700/0da1f/products/139/images/842/204_pinSODIMMDDR3kit_2_mac__38398.1365840646.1280.1280.gif?c=2',
                    "country": 'uk'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.flexxmemory.co.uk/desktop-memory/16gb-kit-8gbx2-240-pin-dimm-ddr3-pc3-12800-1600mhz-memory-module/",
            "html" :cache.load("http://www.flexxmemory.co.uk/desktop-memory/16gb-kit-8gbx2-240-pin-dimm-ddr3-pc3-12800-1600mhz-memory-module/")
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "16GB kit (8GBx2), 240-pin DIMM, DDR3 PC3-12800, 1600MHz memory module",
                    "price": "63.99",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": "http://cdn2.bigcommerce.com/server5700/0da1f/products/289/images/759/th_240_pinDIMMDDR3kit_2__37699__97147.1362759633.1280.1280.gif?c=2",
                    "country": "uk"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.flexxmemory.co.uk/categories/desktop-memory.html",
            "html" :cache.load("http://www.flexxmemory.co.uk/categories/desktop-memory.html")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": 17,
                    "pages": 6,
                    "url" : "http://www.flexxmemory.co.uk/categories/desktop-memory.html"
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

     describe('Not a search page', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "https://www.flexxmemory.co.uk/desktop-memory/hynix-original-8gb-240-pin-dimm-unbuffered-non-ecc-ddr3-pc3-12800-desktop-memory-module-hmt41gu6bfr8c-pb/",
            "html" :cache.load("https://www.flexxmemory.co.uk/desktop-memory/hynix-original-8gb-240-pin-dimm-unbuffered-non-ecc-ddr3-pc3-12800-desktop-memory-module-hmt41gu6bfr8c-pb/")
        }

        it('should return null items and pages', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": null,
                    "pages": null,
                    "url" : "https://www.flexxmemory.co.uk/desktop-memory/hynix-original-8gb-240-pin-dimm-unbuffered-non-ecc-ddr3-pc3-12800-desktop-memory-module-hmt41gu6bfr8c-pb/"
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "http://www.flexxmemory.co.uk/categories/desktop-memory.html",
            "html" :cache.load("http://www.flexxmemory.co.uk/categories/desktop-memory.html")
        }

        it('should be true when correct category is returned', function (done) {

            Structure(payload, function(err, category) {
                var expected = JSON.stringify({
                    "name": "Desktop memory",
                    "url" : "http://www.flexxmemory.co.uk/categories/desktop-memory.html"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.flexxmemory.co.uk/categories/hard-drives-and-ssd-s.html",
            "html" :cache.load("https://www.flexxmemory.co.uk/categories/hard-drives-and-ssd-s.html")
        }

        // Change to be the number of products on the page
        var x = 12;
        it('should return ' + x + ' number of products', function (done) {
            Structure(payload, function(err, result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'OWC \'Data Doubler\' SSD/2.5\" Hard Drive installation Kit for Mac mini 2011, 2012 & Later Models with Upper Drive Bay populated'
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(err, result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '25.20',
                    url: 'https://www.flexxmemory.co.uk/accessories/owc-data-doubler-optical-to-sata-drive-converter/owc-data-doubler-ssd-2-5-hard-drive-installation-kit-for-mac-mini-2011-2012-later-models-with-upper-drive-bay-populated/',
                    image: 'https://cdn7.bigcommerce.com/s-0da1f/images/stencil/500x659/products/1364/4704/OWCDIYIMM11D2B_gall1__09001.1507378660.jpg?c=2',
                    country: 'uk'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'Hynix Canvas 120GB, 2.5 inch Solid state drive SSD SATA III - 6Gb/s, TLC, HFS120G32TND-N1A2A';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(err, result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '49.45',
                    url: 'https://www.flexxmemory.co.uk/apple-mac-hard-drives-ssds/ssds-for-2006-and-2007-imacs/hynix-canvas-120gb-2-5-inch-solid-state-drive-ssd-sata-iii-6gb-s-tlc-hfs120g32tnd-n1a2a/',
                    image: 'https://cdn7.bigcommerce.com/s-0da1f/images/stencil/500x659/products/1368/4740/71OpX6YK5XL._SL1500___19634.1490273918.jpg?c=2',
                    country: 'uk'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
