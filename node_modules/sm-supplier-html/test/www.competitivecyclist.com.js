var should = require('should');
var Structure = require('../lib/structure.js')

describe('www.competitivecyclist.com', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.competitivecyclist.com/niner-jet-9-carbon-gx-complete-mountain-bike-2015?skidn=NNR004Y-BLAGRE-XS&ti=UExQIENhdDpNb3VudGFpbiBCaWtlcyAmIEZyYW1lczoxOjQ6Y2NDYXQxMDAxNjA="
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Niner Jet 9 Carbon GX Complete Mountain Bike - 2015",
                    "price": "2599.00",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'http://content.competitivecyclist.com/images/items/large/NNR/NNR004Y/BLAGRE.jpg',
                    "country": 'us',
                    "description": "If your ride style calls for carbon, but your wallet can't quite pony up, the 2015 Niner Jet 9 Carbon GX Complete Mountain Bike might be just the ticket. This model takes the lightweight, stiff alloy used only in the previous iteration's rear suspension links and extends it throughout the back end. Mixing the aluminum rear triangle and 12x142mm thru axle with a carbon front triangle puts the race-proven geometry of the Jet 9 in a more affordable price range while keeping the focus on stiffness. The cumulatively stiffer ride maintains carbon's efficiency, tracks more precisely over technical terrain, and protects the oversized cartridge bearings of the suspension. We've taken the liberty of kitting this frame out with 120mm of plush RockShox front travel, SRAM's GX one-by drivetrain and Guide RS hydraulic brakes, and a smooth-spinning set of Mavic Crossroc hoops. Other than that back end boost, much of the Jet 9 Carbon resembles the previous model. It shares a carbon monocoque main triangle and many of the RDO's features, including a PressFit 30 bottom bracket, cleanly routed internal cables, and relatively stubby chainstays. Most importantly though, they share the same eager 29er geometry. While the current, industry-wide love of 29ers has some manufacturers scrambling to find a solution to full suspension/29er compatibility issues, Niner has been sitting pretty with its 100mm of CVA travel for some time. The CVA suspension's lower link sits below the bottom bracket, which puts bike's virtual instant center ahead of the drivetrain and effectively isolates the drivetrain from the rear triangle. When you press on the pedals, nothing's lost to compressing the suspension, and you won't suffer kickback from chainstay growth when taking advantage of the 29er's ability to push on through rock gardens. A low ratio of shock stroke to suspension movement further adds to CVA's trail appeal. This decreases the amount of preload needed, which translates to smooth, effective damping and less drag on the shock seals. For 2015, Niner trusts its CVA design to RockShox with the Monarch RT3 rear shock, whose three distinct damping settings (open, pedal, and lock) let you adjust the bike's platform as required by trail conditions"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.competitivecyclist.com/race-face-bb30-bottom-bracket-adapter?skidn=RCF0302&ti=UExQIENhdDpCaWtlIEJvdHRvbSBCcmFja2V0czozOjE0OmNjQ2F0MTAwNDY2"
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Race Face BB30 Bottom Bracket Adapter",
                    "price": "50.99",
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAA1BMVEX///+nxBvIAAAAAXRSTlMAQObYZgAAABJJREFUeF4FwIEIAAAAAKD9qY8AAgABdDtSRwAAAABJRU5ErkJggg==',
                    "country": 'us',
                    "description": "Don't let yourself be limited in crankset choice. Race Faceâ€™s BB30 Bottom Bracket Adapter lets you use all Race Face, Shimano, and select FSA 24mm spindle mountain cranksets in BB30 shell frames. The Adapter's press-fit bearing cups work like an external type headset. This positions the bearings externally with exactly the same spacing as threaded external mountain BBs. The Adapter features precision, CNC machined and anodized aluminum alloy cups, which means a more accurate, durable, and stable press-fit interface as compared with plastic molded cups. The Race Face BB30 Bottom Bracket Adapter comes in one size and weighs 110 grams."
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.competitivecyclist.com/mountain-bikes"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": 42,
                    "pages": 5
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.competitivecyclist.com/cameras?fl=true"
        }

        // Change to be the number of products on the page
        var x = 20;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'GoPro HERO5 Session';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '299.99',
                    url: 'http://www.competitivecyclist.com/gopro-hero-5-session?skidn=GOP006I-ONECOL-ONESIZ&ti=UExQIENhdDpDYW1lcmFzOjE6MTpjY0NhdDEwMDA0Nw==',
                    image: 'http://content.competitivecyclist.com/images/items/medium/GOP/GOP006I/ONECOL.jpg',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'K-Edge Go-Big Pro Saddle Rail Mount';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '29.99',
                    url: 'http://www.competitivecyclist.com/k-edge-go-big-pro-saddle-rail-mount?skidn=KEG0016-GUN-ONESIZ&ti=UExQIENhdDpDYW1lcmFzOjE6MjA6Y2NDYXQxMDAwNDc=',
                    image: 'http://content.competitivecyclist.com/images/items/medium/KEG/KEG0016/GUN.jpg',
                    country: 'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
