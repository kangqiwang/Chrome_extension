var should = require('should');
var Structure = require('../lib/structure.js')

describe('replaceWithwebAddress', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.waterstones.com/book/13-minutes/sarah-pinborough/9780575097377"
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "13 Minutes (Paperback)",
                    "price": "5.99",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'https://53dde335a2dce2ca942c-498c68ea2e9d4fdb160dd89f86b552f2.ssl.cf3.rackcdn.com/v1/large/9780/5750/9780575097377.jpg',
                    "country": 'uk',
                    "description": "I was dead for 13 minutes. I don't remember how I ended up in the icy water but I do know this - it wasn't an accident and I wasn't suicidal. They say you should keep your friends close and your enemies closer, but when you're a teenage girl, it's hard to tell them apart. My friends love me, I'm sure of it. But that doesn't mean they didn't try to kill me. Does it? 13 MINUTES by Sarah Pinborough is a gripping psychological thriller about people, fears, manuiplation and the power of the truth. A stunning read, it questions our relationships - and what we really know about the people closest to us ..."
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.waterstones.com/product/tolkien-calendar-2017/j-r-r-tolkien/9780008163396"
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Tolkien Calendar 2017: The Hobbit 80th Anniversary (Calendar)",
                    "price": null,
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'https://53dde335a2dce2ca942c-498c68ea2e9d4fdb160dd89f86b552f2.ssl.cf3.rackcdn.com/v1/large/9780/0081/9780008163396.jpg',
                    "country": 'uk',
                    "description": "This year's calendar features black and white paintings by J.R.R. Tolkien himself from the beloved children's classic, The Hobbit. This year's calendar features 13 paintings and illustrations by J.R.R. Tolkien himself, which were drawn by Tolkien when writing his beloved children's classic, The Hobbit. They provide a fascinating insight into how Tolkien imagined the world of Middle-earth would look. The images are accompanied by extracts from Tolkien's letters, providing exquisite insight into both the writing process, and the illustrations themselves."
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "https://www.waterstones.com/category/science-fiction-fantasy-horror/fantasy"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": 24,
                    "pages": 1389
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "https://www.waterstones.com/category/science-fiction-fantasy-horror/fantasy"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(category) {
                var expected = JSON.stringify({
                    "name": "Fantasy books"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.waterstones.com/books/bestsellers/sort/bestselling?page=2"
        }

        // Change to be the number of products on the page
        var x = 24;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'Cooking for Family and Friends';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '9.99',
                    url: 'https://www.waterstones.com/book/cooking-for-family-and-friends/joe-wicks/9781509820252',
                    image: 'https://cdn.waterstones.com/override/v1/medium/9781/5098/9781509820252.jpg',
                    country: 'uk'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'Tom Gates: Family, Friends and Furry Creatures';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '8.49',
                    url: 'https://www.waterstones.com/book/tom-gates-family-friends-and-furry-creatures/liz-pichon/9781407168111',
                    image: 'https://cdn.waterstones.com/bookjackets/medium/9781/4071/9781407168111.jpg',
                    country: 'uk'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
