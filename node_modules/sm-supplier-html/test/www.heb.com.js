var should = require('should');
var Structure = require('../lib/structure.js')

describe('www.heb.com', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.heb.com/product-detail/gtc-8gb-usb-2-0-high-speed-flash-drive/1741906"
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "GTC 8GB USB 2.0 High Speed Flash Drive",
                    "price": "5.97",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'https://images.heb.com/is/image/HEBGrocery/001741906-1?id=CszRd0&fmt=jpg&fit=constrain,1&wid=269&hei=296',
                    "country": 'us',
                    "description": 'GTC 8GB USB High Speed Flash Drive. Features large capacity storage to store or transport your favorite documents, music, video clips, photos and more.'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.heb.com/product-detail/jvc-gumy-black-earbud/1854830#product-description"
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "JVC Gumy Black Earbud",
                    "price": "9.99",
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'https://images.heb.com/is/image/HEBGrocery/001854830-1?id=mkdRN0&fmt=jpg&fit=constrain,1&wid=296&hei=296',
                    "country": 'us',
                    "description": 'JVC HAFX5B GUMY Plus In Ear Earbud Headset â€‘ Black.'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "https://www.heb.com/category/shop/entertainment-and-electronics/computers-and-tablets/accessories-and-storage/2900/2902?N=10787&No=0&_requestid=164165&prodFilter=none"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": 35,
                    "pages": 13
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })


    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "https://www.heb.com/category/shop/entertainment-and-electronics/computers-and-tablets/accessories-and-storage/2900/2902?N=10787&No=0&_requestid=164165&prodFilter=none"
        }

        it('should be true when correct category is returned', function (done) {

            Structure(payload, function(category) {
                var expected = JSON.stringify({
                    "name": "Accessories and Storage"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.heb.com/category/shop/health-and-beauty/makeup/makeup-tools-and-accessories/brushes-and-applicators/25974/25973"
        }

        // Change to be the number of products on the page
        var x = 35;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'L\'Oreal Paris Infallible Blend Foundation Blender';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '6.97',
                    url: 'https://www.heb.com/product-detail/l-oreal-paris-infallible-blend-foundation-blender/2061052',
                    image: 'https://images.heb.com/is/image/HEBGrocery/prd-small/l-oreal-paris-infallible-blend-foundation-blender-002061052.jpg',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'e.l.f. Blending Brush';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '3.00',
                    url: 'https://www.heb.com/product-detail/e-l-f-blending-brush/1943512',
                    image: 'https://images.heb.com/is/image/HEBGrocery/prd-small/e-l-f-blending-brush-001943512.jpg',
                    country: 'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
