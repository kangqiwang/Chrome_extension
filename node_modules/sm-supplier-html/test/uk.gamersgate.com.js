var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')

describe('replaceWithwebAddress', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://uk.gamersgate.com/DD-BURLY-MEN-AT-SEA/burly-men-at-sea",
            "html" : cache.load("https://uk.gamersgate.com/DD-BURLY-MEN-AT-SEA/burly-men-at-sea")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Burly Men At Sea PC/Mac",
                    "price": "6.99",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'uk.gamersgate.com/media/products/profile/121176/180_259.jpg/w122/',
                    "country": 'uk',
                    "description": "One of TIME’s top five games of 2016, Burly Men at Sea is a folktale about a trio of large, bearded fishermen who step away from the ordinary to seek adventure.Set in the waters of early 20th-century Scandinavia, the game's story branches through a series of encounters with creatures from folklore. You play as storyteller and wayfinder, shaping the narrative around three ungainly heroes. Play through once for a single tale, then set sail again to uncover paths to new adventures.Named Best Story Game of 2016 by Rock, Paper, Shotgun, and nominee for Best 2D Visuals (Unity Awards 2016), SXSW Gamer’s Voice Award (2016), and Best Adventure Game/RPG (Intel Level Up 2016).Key Features:Branching Story: Play through multiple adventures, each designed to be completed in a single sitting.Interactive World: Shape the narrative through interaction with characters and the world around them, set inside a draggable, interactive vignette.Playful Aesthetic: Colorful art style with handcrafted animation, set to a whimsical original soundtrack inspired by the game’s Scandinavian setting."
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    // describe('Out of Stock Page', function() {

    //     var payload = {
    //         "pageType" : "product",
    //         "url" : ""
    //     }

    //     it('should be false when product is in store only', function (done) {

    //         Structure(payload, function(inStockPage) {
    //             var expected = JSON.stringify({
    //                 "name": "",
    //                 "price": "",
    //                 "url": null,
    //                 "inStock": false,
    //                 "stockLevel": null,
    //                 "image": '',
    //                 "country": '',
    //                 "description": ''
    //             })
    //             JSON.stringify(inStockPage).should.equal(expected);
    //             done()
    //         })
    //     });

    // });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "https://uk.gamersgate.com/games?state=available",
            "html" : cache.load("https://uk.gamersgate.com/games?state=available")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": 30,
                    "pages": 187
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "https://uk.gamersgate.com/games?state=available",
            "html" : cache.load("https://uk.gamersgate.com/games?state=available")
        }

        it('should be true when correct category is returned', function (done) {

            Structure(payload, function(err, category) {
                var expected = JSON.stringify({
                    "name": "Games"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://uk.gamersgate.com/games?state=available",
            "html" : cache.load("https://uk.gamersgate.com/games?state=available")
        }

        // Change to be the number of products on the page
        var x = 30;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(err, result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'Burly Men At Sea';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(err, result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '6.99',
                    url: 'https://uk.gamersgate.com/DD-BURLY-MEN-AT-SEA/burly-men-at-sea',
                    image: 'uk.gamersgate.com/media/products/profile/121176/180_259.jpg/w122/',
                    country: 'uk'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'Steep Season Pass';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(err, result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '13.11',
                    url: 'https://uk.gamersgate.com/DLC-STEEP-SEASON-PASS-EMEA/',
                    image: 'uk.gamersgate.com/media/products/profile/115989/180_259.jpg/w122/',
                    country: 'uk'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
