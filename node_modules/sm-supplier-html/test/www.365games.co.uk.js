var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')

describe('www.365games.co.uk', function() {

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.365games.co.uk/party-and-family-board-games/stranger-things-monopoly",
            "html" : cache.load("https://www.365games.co.uk/party-and-family-board-games/stranger-things-monopoly")
        }

        it('should be true when product is in stock', function () {
            const inStockPage =  Structure(payload)            
            inStockPage.name.should.be.equal("Stranger Things Monopoly");
            inStockPage.price.should.be.equal("24.99");
            inStockPage.url.should.be.equal("https://www.365games.co.uk/party-and-family-board-games/stranger-things-monopoly");
            inStockPage.inStock.should.be.equal(true);
            should(inStockPage.stockLevel).be.equal(null);
            inStockPage.inStock.should.be.equal(true);
            inStockPage.image.should.be.equal('https://d8mkdcmng3.imgix.net/ec8b/board-games-party-and-family-stranger-things-monopoly-3.jpg?h=600&q=100&w=600&s=6c69397adc9fa5ac49bf18e3bdbc4ef6');
            inStockPage.country.should.be.equal('uk');            
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.365games.co.uk/board-game-guides-and-books/shadow-of-the-tomb-raider-official-collectors-edition-guide",
            "html" : cache.load("https://www.365games.co.uk/board-game-guides-and-books/shadow-of-the-tomb-raider-official-collectors-edition-guide")
        }

        it('should return false when product is out of stock', function() {
            const inStockPage =  Structure(payload)            
            inStockPage.name.should.be.equal("Shadow of the Tomb Raider Official Collector\'s Edition Guide");
            inStockPage.price.should.be.equal("19.99");
            inStockPage.url.should.be.equal("https://www.365games.co.uk/board-game-guides-and-books/shadow-of-the-tomb-raider-official-collectors-edition-guide");
            inStockPage.inStock.should.be.equal(false);
            should(inStockPage.stockLevel).be.equal(null);
            inStockPage.image.should.be.equal('https://d8mkdcmng3.imgix.net/1325/books-board-game-guides-rule-and-reference-books-shadow-of-the-tomb-raider-official-collectors-edition-guide.jpg?bg=0FFF&fit=fill&h=600&q=100&w=600&s=489cb19ee0883e632cd72eb28ea019d1');
            inStockPage.country.should.be.equal('uk');            
            })

    })

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.365games.co.uk/ps4-games",
            "html" : cache.load("http://www.365games.co.uk/ps4-games")
        }

        it('should be true when number of items and pages correct', function () {

            var expected = JSON.stringify({
                "items": 100,
                "pages": 30,
                "url":"http://www.365games.co.uk/ps4-games"
            })

            const pagination = Structure(payload)
            JSON.stringify(pagination).should.equal(expected);
        });

    });

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "https://www.365games.co.uk/ps4-games",
            "html" : cache.load("https://www.365games.co.uk/ps4-games")
        }

        it('should be true when number of items and pages correct', function () {

            var expected = JSON.stringify({
                "name": "PS4 Games",
                "url":"https://www.365games.co.uk/ps4-games"
            })

            const category = Structure(payload)

            JSON.stringify(category).should.equal(expected);
        });

    });
    
    describe('Search Page', function() {

            var payload = {
                "pageType" : "search",
                "url" : "https://www.365games.co.uk/ps4-games",
                "html" : cache.load("https://www.365games.co.uk/ps4-games")
            }

            // Change to be the number of products on the page
            var x = 65;
            it('should return ' + x + ' number of products', function () {
                let result = Structure(payload)
                result.length.should.equal(x);
                });

            var firstProductName = 'METAL MAX Xeno PS4 GamePlayer Points';
            it('first product should be ' + firstProductName, function() {
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '28.99',
                    url: 'https://www.365games.co.uk/ps4-games/metal-max-xeno-ps4-game',
                    image: 'https://d8mkdcmng3.imgix.net/2eba/pc-and-video-games-games-ps4-metal-max-xeno.png?bg=0FFF&fit=fill&h=126&q=80&w=126&s=669e457e47d6a6ea399ce76681addad8',
                    country: 'uk'
                })

                let result = Structure(payload)

                var first = result.shift()
                
                JSON.stringify(first).should.equal(expected)    
    
            })

            var lastProductName = 'Dark Souls III The Fire Fades Game Of The Year (GOTY) PS4 Game';
            it('last product should be ' + lastProductName, function () {
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '32.99',
                    url: 'https://www.365games.co.uk/ps4-games/dark-souls-iii-the-fire-fades-game-of-the-year-goty-ps4-game',
                    image: 'https://d8mkdcmng3.imgix.net/475c/pc-and-video-games-games-ps4-dark-souls-iii-the-fire-fades-edition-of-the-year-edition.jpg?h=176&q=90&w=176&s=47347bbceb602a51cbd2e6a199a10a4f',
                    country: 'uk'
                })
    
                const result = Structure(payload);
    
                var last = result.pop()
                JSON.stringify(last).should.equal(expected)
            });

        });

    });

