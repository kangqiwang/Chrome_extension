var should = require('should');
var Structure = require('../lib/structure.js')

describe('replaceWithwebAddress', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.faucetdirect.com/kovacs-gk-p600-3-1-light-plug-in-wall-sconce-from-the-george-s-reading-room-collection/p307905"
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Kovacs P600-3-615 Antique Bronze 1 Light Plug In Wall Sconce from the George's Reading Room Collection",
                    "price": "157.50",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'https://s3.img-b.com/image/private/t_base,f_auto,c_lpad,h_800/product/Kovacs/P600-3-615_updated.jpg',
                    "country": 'us',
                    "description": "Single Light Plug In Wall Sconce from the George's Reading Room P3 Series"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.faucetdirect.com/kohler-k-218-traditional-tempered-glass-shelf-for-bath-or-powder-room-from-antique-collection/p220576"
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Kohler K-218-BN Brushed Nickel Traditional Tempered Glass Shelf for Bath or Powder Room from Antique Collection",
                    "price": "",
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'https://s3.img-b.com/image/private/t_base,f_auto,c_lpad,h_800/product/Kohler/k-218bn.jpg',
                    "country": "us",
                    "description": 'Antique(tm) glass shelf'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "https://www.faucetdirect.com/index.cfm?p=1&page=search:browse&searched=browse:category&term=room&r=96"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": 96,
                    "pages": 2
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })


    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "https://www.faucetdirect.com/bathroom-sinks/c55"
        }

        it('should be true when correct category is returned', function (done) {

            Structure(payload, function(category) {
                var expected = JSON.stringify({
                    "name": "Bathroom Sinks"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.faucetdirect.com/index.cfm?p=1&page=search:browse&searched=browse:category&term=room&r=96"
        }

        // Change to be the number of products on the page
        var x = 70;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'Kovacs GK P600-3';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '157.50',
                    url: 'https://www.faucetdirect.com/kovacs-gk-p600-3-1-light-plug-in-wall-sconce-from-the-george-s-reading-room-collection/p307905',
                    image: 'https://s3.img-b.com/image/private/t_base,f_auto,c_lpad,w_220,h_220/product/Kovacs/P600-3-615_updated.jpg',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'Honey-Can-Do SFTX06694';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: "35.35",
                    url: 'https://www.faucetdirect.com/honey-can-do-sftx06694-four-piece-room-organization-kit-with-under-bed-storage-bag/p2932963',
                    image: 'https://s3.img-b.com/image/private/t_base,f_auto,c_lpad,w_220,h_220/product/Honey-Can-Do/honey-can-do-sftx06694.jpg',
                    country: 'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
