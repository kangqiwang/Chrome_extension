var should = require('should');
var Structure = require('../lib/structure.js')

describe('replaceWithwebAddress', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.carid.com/otc/dual-wheel-inboard-bead-breaker-bar-mpn-5729.html"
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "OTC® 5729 - Dual Wheel Inboard Bead Breaker Bar",
                    "price": "188.96",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'https://www.carid.com/images/otc/wheels-tires-accessories/otc5729.jpg',
                    "country": 'us',
                    "description": 'Dual Wheel Inboard Bead Breaker Bar by OTC®. Breaks the inner bead on the outside tire without removing the wheel from the truck. Unique design places pressure in the exact location required to quickly and easily break the inner bead. Simply pull up on the handle and the bead is forced off the wheel rim.'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : 'https://www.carid.com/replace/18-remanufactured-5-spokes-silver-factory-alloy-wheel-mpn-aly03834u20tp.html'
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": 'Replace® ALY03834U20TP - 18" Remanufactured 5 Spokes Silver Factory Alloy Wheel',
                    "price": "161.39",
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'https://www.carid.com/images/replace/factory-wheels/aly03834u20tp-1.jpg',
                    "country": 'us',
                    "description": '18" Remanufactured 5 Spokes Silver Factory Alloy Wheel (ALY03834U20TP) by Replace®. 18" x 8". Bolt Pattern: 5 x 114.3 mm. Wheel and Tire Package. Scraped, scuffed, bent, dented, or otherwise damaged wheels can detract from the appearance of a nice vehicle, but more importantly, can cause an unsafe driving condition. Damaged wheels may not hold air and can cause unsafe vehicle handling. If you’re in need of a replacement alloy wheel, don’t pay the high price at the dealer. Replace has remanufactured factory alloy wheels that meet or exceed new factory wheel standards. A Replace remanufactured factory alloy wheel will appear and function the same as a new wheel for much less cash, and it carries a limited lifetime warranty.'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "https://www.carid.com/search/wheel/code-d68283fb4f6942230fdd74aadf9c6d4f/perpage-120"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": 120,
                    "pages": 310
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "https://www.carid.com/car-stereos.html"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(category) {
                var expected = JSON.stringify({
                    "name": "Car Stereos"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.carid.com/single-din-stereos/"
        }

        // Change to be the number of products on the page
        var x = 60;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'Power Acoustik® Single DIN DVD/CD/AM/FM/MP3/MP4 Receiver with Motorized 7\" Touchscreen Display and Built-In Bluetooth (PTID8920B)';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '136.56',
                    url: 'https://www.carid.com/power-acoustik/single-din-stereo-receiver-mpn-ptid8920b.html?singleid=97198861',
                    image: 'https://www.carid.com/ic/power-acoustik/stereos/ptid8920b_6.jpg',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'Pyle® Single DIN DVD/VCD/CD/AM/FM/MP3/MP4/AVI/WAV Receiver with 7\" Motorized Touchscreen Display, Built-In Bluetooth and Rearview Backup Camera Input (PLDT87BT)';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '157.19',
                    url: 'https://www.carid.com/pyle/single-din-dvd-vcd-cd-am-fm-mp3-mp4-avi-wav-receiver-mpn-pldt87bt.html?singleid=479660951',
                    image: 'https://www.carid.com/ic/pyle/stereos/pldt87bt_6.jpg',
                    country: 'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
