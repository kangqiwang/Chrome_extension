var should = require('should');
var Structure = require('../lib/structure.js')

describe('shop.marvel.com', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://shop.marvel.com/gamora-and-star-lord-action-figure-set-guardians-of-the-galaxy-6/mp/19745/1000242/"
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Gamora and Star-Lord - Marvel Legends Series Action Figure Set - Guardians of the Galaxy - 6''",
                    "price": "24.95",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'https://cdn-ssl.s7.shop.marvel.com/is/image/MarvelStore/630509452934?$yetidetail$',
                    "country": 'us',
                    "description": "Mix it up When the battle for justice goes cosmic, our heroes blast into action with sweet tunes and expert moves. These highly articulated Gamora and Star-Lord figures feature a comic-inspired design - an epic addition to the Marvel Legends Series. See more"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://shop.marvel.com/play-sets-more-toys-iron-man-mr-potato-head/mp/14831/1000244/"
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Iron Man Mr Potato Head",
                    "price": "16.95",
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'https://cdn-ssl.s7.shop.marvel.com/is/image/MarvelStore/6171056181505?$yetidetail$',
                    "country": 'us',
                    "description": "Magnetic peel Inventor Tony Stark has come up with a radical new suit for the Invincible Iron Man Mr Potato Head. With helmet and repulsor at the ready, this is one Avenger your very own super hero will love to assemble. See more"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "https://shop.marvel.com/toys/mn/1000208/"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": 95,
                    "pages": 2
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })


    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "https://shop.marvel.com/toys/mn/1000208/"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(category) {
                var expected = JSON.stringify({
                    "name": "Toys"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://shop.marvel.com/toys/mn/1000208/"
        }

        // Change to be the number of products on the page
        var x = 95;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = "Ultimate Spider-Man vs. The Sinister Six: Marvel's Vulture Action Figure - 6''";
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '8.21',
                    url: 'https://shop.marvel.com/ultimate-spider-man-vs-the-sinister-six-marvels-vulture-action-figure-6/mp/19807/1000242/',
                    image: 'https://cdn-ssl.s7.shop.marvel.com/is/image/MarvelStore/630509401666?$yeti3UPList$',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = "Vision ''Tsum Tsum'' Plush - Marvel's Avengers Series 2 - Mini - 3 1/2''";
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '4.16',
                    url: 'https://shop.marvel.com/vision-tsum-tsum-plush-marvels-avengers-series-2-mini-3-1/2/mp/18726/1000245/',
                    image: 'https://cdn-ssl.s7.shop.marvel.com/is/image/MarvelStore/1234041280333?$yeti3UPList$',
                    country: 'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
