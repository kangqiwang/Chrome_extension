var should = require('should');
var Structure = require('../lib/structure.js')

describe('www.tfaw.com', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.tfaw.com/Comics/Profile/Simpsons-Illustrated-26___523079"
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Simpsons Illustrated #26",
                    "price": "4.49",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'http://d2lzb5v10mb0lj.cloudfront.net/covers_tfaw/200/se/sep161379.jpg',
                    "country": 'us',
                    "description": "Hark! Celebrate the winter break around the hearth with a healthy helping of heartfelt holiday stories! First, Mr. Burns jacks up the cost of power in Springfield with alarming results! Then, Homer goes into hibernation for the winter. Next up, Ned Flanders gets a lesson in the 'true' meaning of Christmas. And, when all the girls at Springfield Elementary try to capture Bart beneath the mistletoe, will he remain cootie-free? Finally, Homer does everything he can to get the whole family to attend the Springfield Holiday Parade."
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.tfaw.com/Graphic-Novels/Profile/Thought-Bubble-Anthology-Coll-10-Years-Of-Comics-TPB___519407"
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Thought Bubble Anthology Coll 10 Years Of Comics TPB",
                    "price": "7.99",
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'http://d2lzb5v10mb0lj.cloudfront.net/covers_tfaw/200/AU/AUG160710.jpg',
                    "country": 'us',
                    "description": "Commemorating the 10th anniversary of the Thought Bubble Festival, which takes place in Leeds, Northern England, from Nov 1-6, 2016, this collection features short stories and art by: CHARLIE ADLARD, GABRIEL BAUTISTA, GABRIEL BÁ, KATE BEATON, JORDIE BELLAIRE, IVAN BRANDON, JEFFERY BROWN, MARK BUCKINGHAM, CLARK BURSCOUGH, ADAM CADWELL, MIKE CAREY, EMILY CARROLL, CLIFF CHIANG, BECKY CLOONAN, BOO COOK, FAREL DALRYMPLE, RUFUS DAYGLO, ANDY DIGGLE, D'ISRAELI, MARC ELLERBY, MING DOYLE, WARREN ELLIS, GARY ERSKINE, CARLOS EZQUERRA, RAY FAWKES, DUNCAN FEGREDO, ROBIN FURTH, LEIGH GALLAGHER, STUART GORDON, BRANDON GRAHAM, NICHOLAS GUREWITCH, TONY HARRIS, WILL MORRIS, ANTONY JOHNSTON, BARRY KITSON, ALES KOT, EMI LENOX, TULA LOTAY, SARAH MCINTYRE, FABIO MOON, STEPHEN MOONEY, RAMON PEREZ, SEAN PHILLIPS, RICK REMENDER, EMMA RÍOS, TIM SALE, FIONA STAPLES, CAMERON STEWART, RICHARD STARKINGS, BABS TARR, EMMA VIECELI, ANNIE WU & SKOTTIE YOUNG. All profits from this collection go to Barnardo's, one of the largest children's charities in the UK. See more at: www.thoughtbubblefestival.com"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.tfaw.com/Graphic-Novels/Genres/Anthology?_results_prod_type_search=Graphic+Novels&_results_genres_search=Anthology&_results_ordercombo_search=heat_factor&gallery_mode=grid&_results_limit_search=90"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": 90,
                    "pages": 2
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "http://www.tfaw.com/Graphic-Novels/Genres/Anthology?_results_prod_type_search=Graphic+Novels&_results_genres_search=Anthology&_results_ordercombo_search=heat_factor&gallery_mode=grid&_results_limit_search=90"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(category) {
                var expected = JSON.stringify({
                    "name": "Graphic Novels"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "http://www.tfaw.com/Graphic-Novels/Genres/Anthology?_results_prod_type_search=Graphic+Novels&_results_genres_search=Anthology&_results_ordercombo_search=heat_factor&gallery_mode=grid&_results_limit_search=90"
        }

        // Change to be the number of products on the page
        var x = 90;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'Caliber Presents GN Vol. 02';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '8.99',
                    url: 'http://www.tfaw.com/Graphic-Novels/Profile/Caliber-Presents-GN-Vol.-02___525830',
                    image: 'http://d2lzb5v10mb0lj.cloudfront.net/covers_tfaw/100/oc/oct161379.jpg',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'Invincible Days HC';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '15.99',
                    url: 'http://www.tfaw.com/Graphic-Novels/Profile/Invincible-Days-HC___456450',
                    image: 'http://d2lzb5v10mb0lj.cloudfront.net/covers_tfaw/100/ju/jun141322.jpg',
                    country: 'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
