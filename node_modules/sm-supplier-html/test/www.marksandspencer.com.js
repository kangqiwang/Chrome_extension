var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')


describe('www.marksandspencer.com', function () {

    before(function () {
        this.timeout(5000);
    })


    describe('Search Page', function () {

        var payload = {
            "pageType": "search",
            "url": "http://www.marksandspencer.com/l/wine-shop/wine-beer-and-spirits/red-wine",
            "html": cache.load("http://www.marksandspencer.com/l/wine-shop/wine-beer-and-spirits/red-wine")
        }

        it('should return 67 products', function (done) {
            Structure(payload, function (err, result) {
                result.length.should.equal(97);
                done()
            })
        });

        it('last product should be Bichot Bourgogne Hautes-Côtes de Beaune - Case of 6', function (done) {
            Structure(payload, function (err, result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: 'Bichot Bourgogne Hautes-Côtes de Beaune - Case of 6',
                    price: '87.00',
                    url: 'http://www.marksandspencer.com/bichot-bourgogne-hautes-ctes-de-beaune-2011/p/p60054098?prevPage=plp',
                    image: 'http://asset1.cxnmarksandspencer.com/is/image/mands/FD_FD_F23A_00956215_NC_X_EC_0?$PLP_PRODUCT_IMAGE$',
                    country: 'uk'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

        it('first product should be Cotes du Rhone Villages - Case of 6', function (done) {
            Structure(payload, function (err, result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: 'Cotes du Rhone Villages - Case of 6',
                    price: '33.00',
                    url: 'http://www.marksandspencer.com/cotes-du-rhone-villages-case-of-6/p/p60072088?prevPage=plp',
                    image: 'http://asset1.cxnmarksandspencer.com/is/image/mands/HT_FD_F23A_00051750_NC_X_EC_0?$PLP_PRODUCT_IMAGE$',
                    country: 'uk'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

    });

    describe('Search page pagination', function () {

        var payload = {
            "pageType": "pagination",
            "url": "http://www.marksandspencer.com/l/kids/toys-and-books/toys",
            "html": cache.load("http://www.marksandspencer.com/l/kids/toys-and-books/toys")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function (err, pagination) {
                var expected = JSON.stringify({
                    "items": 96,
                    "pages": 2,
                    "url": "http://www.marksandspencer.com/l/kids/toys-and-books/toys"
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search page category', function () {

        var payload = {
            "pageType": "category",
            "url": "http://www.marksandspencer.com/l/kids/toys-and-books/toys",
            "html": cache.load("http://www.marksandspencer.com/l/kids/toys-and-books/toys")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function (err, category) {
                var expected = JSON.stringify({
                    "name": "Toys",
                    "url": "http://www.marksandspencer.com/l/kids/toys-and-books/toys"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });


    describe('In Stock Page', function () {

        var payload = {
            "pageType": "product",
            "url": "http://www.marksandspencer.com/charlotte-doll/p/p22455890",
            "html": cache.load("http://www.marksandspencer.com/charlotte-doll/p/p22455890")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function (err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Charlotte Rag Doll",
                    "price": "14.00",
                    "url": payload.url,
                    "inStock": true,
                    "stockLevel": null,
                    "image": "http://asset1.cxnmarksandspencer.com/is/image/mands/SD_04_T79_5637_ZZ_X_EC_0",
                    "country": "uk",
                    "description": "Charlotte, in her fun, sporty outfit, would be a perfect playmate for any little one. She loves nothing more than going to a tea party with her friends Ava and Amelia. Buy with the matching Tea Set and Tea Party puzzle that are also available."
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });


    describe('Out of Stock Page', function () {

        var payload = {
            "pageType": "product",
            "url": "http://www.marksandspencer.com/spring-bloom-2-person-wicker-heart-picnic-bag/p/p22442416?prevPage=plp&pdpredirect",
            "html": cache.load("http://www.marksandspencer.com/spring-bloom-2-person-wicker-heart-picnic-bag/p/p22442416?prevPage=plp&pdpredirect")
        }

        it('should return false when product is out of stock', function (done) {

            Structure(payload, function (err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Spring Bloom 2 Person Wicker Heart Hamper",
                    "price": "",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": "http://asset1.cxnmarksandspencer.com/is/image/mands/HT_05_T34_5960S_SQ_X_EC_0",
                    "country": "uk",
                    "description": "Perfect for outdoor dining or heading off for a picnic, our heart shaped spring blooms inspired picnic basket has a beautiful floral...View more details"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        })

    })

});
