var should = require('should');
var Structure = require('../lib/structure.js')

describe('www.steepandcheap.com', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.steepandcheap.com/under-armour-wintersweet-1-2-zip-fleece-jacket-womens?skid=UND00EK-PEAFAL-XS&ti=UExQIENhdDpXb21lbnMgSmFja2V0cyAmIENvYXRzOjE6NDpzYWNDYXQyMTAwMDQ="
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Under Armour Wintersweet 1/2-Zip Fleece Jacket - Women's",
                    "price": "63.99",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'http://content.backcountry.com/images/items/large/UND/UND00EK/PEAFAL.jpg',
                    "country": 'us',
                    "description": "Enjoy the explosion of fiery fall colors and the sound of leaves crunching beneath your feet as you set out for a leisurely hike in the Under Armour Women's Wintersweet 1/2-Zip Fleece Jacket. Its sweater-knit fabric has a brushed interior for a cozy feel in chilly fall temps, and the outside of the fabric is treated to repel light rain or snow, should you run into a bit of foul weather. The half-zip front allows you to vent excess heat during more demanding treks, and the extended length offers extra coverage from the cold."
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.steepandcheap.com/reynolds-46-aero-clincher-wheelset"
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Reynolds 46 Aero Carbon Road Wheelset - Clincher",
                    "price": "",
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'http://content.backcountry.com/images/items/large/REY/REY000G/BK.jpg',
                    "country": 'us',
                    "description": "While Reynolds has a quiver brimming with world-class race wheels, it's calling the 46mm its \"signature rim depth.\" The reason for this is its exceptional versatility and optimal aerodynamics across every discipline of riding. From your ultra-fast weeknight crit series to the steepest of the summer hill climbs, Reynolds' new 46 Aero Carbon Clincher Road Wheelset has you covered. Its construction serves to beautifully illustrate Reynolds' latest generation of lightweight, durable, and aerodynamic carbon wheels. The complexity of the Aero design is deep, but we'll walk through it together. To start, one needs to understand the prevalent ideology in aerodynamic wheel design, and to do so, we need to understand drag. Simply put, drag is the restraining force that acts on the wheel when its direction of motion is counter to the free stream of airflow. Now, airflow near the surface of a wheel is turbulent by nature, and when it comes close to the rim surface, it becomes a turbulent boundary layer. This is the start of two kinds of drag, skin friction and pressure drag. Currently, wheel makers are attempting to harness the turbulent layer, reattaching it at the rear section of the rim. The reasoning behind this is that the system reduces pressure drag, but in return, the wheel sees gains in skin friction. However, this is viewed as a compromising tradeoff, as skin friction has around a ten-fold lower drag value than pressure drag. To maximize this turbulent system, we've been seeing builders create a constant, rounded edge at the spoke face. For those attempting it, it's been viewed as a leap forward in design. However, Reynolds finds it to be counterintuitive. We'll explain. You see, the science of aerodynamics has developed almost as a case of supply and demand. As aviation technology develops, engineers are forced to develop more efficient airfoil designs, and these designs take the shape of what's called a NACA profile — think of a stretched out tear drop shape. In recent years, though, some wheel designers have started to view the NACA profile as insufficient to the aerodynamics of wheels. The reasoning behind this is that while an airfoil only has what are called a leading and trailing edge, the rim's shape requires a trailing edge to double as a leading edge. Thus, we see the wide, rounded spoke faces of today. However, given that these systems rely on turbulence, Reynolds views this development as a step back from the proven designs of the airfoils that smooth turbulence. And this is just what the 46 Aero does with what Reynolds is calling, Dispersive Effect Termination (DET). Starting at the rim bed, the 46 Aero features an ultra-wide maximum width of 26.2mm. As a clincher, this eliminates the drag-increasing balloon effect caused by a tire being wider than a rim. Now, the tire width matches the leading edge of the rim, creating less turbulence at the airflow's introduction to the wheel. The benefits to this design are fourfold — it delivers an aerodynamic benefit, it increases lateral rigidity, it also increases comfort, and it decreases rolling resistance. Moving down to the spoke face, the 46 Aero is shaped in a NACA-profiled, tapered V-shape that ends with a sharp trailing edge. This is where Reynolds starts to challenge the status quo. Basically, the Aero's shape actually smooths airflow over the wheel, and when that air passes the spoke face, it's easily reattached at the rear of the rim. So, the Aero places a focus on mitigating turbulence, not accepting it. So, with DET, drag is greatly reduced. However, Reynolds wasn't content with just this. In fact, Reynolds views the aerodynamic engineering of wheels as a four-part structure. 1) The wheel must be lightweight, yet structurally sound. 2) It must reduce turbulent airflow in order to create a low-drag system. 3) The aerodynamic efforts cannot compromise the steering and handling of the bike. 4) The wheel must generate an aerodynamic advantage from its lift-drag-ratio. Not surprisingly, one wheel rarely encompasses all of these traits. In fact, we find that article numbers Two and Three actually tend to contradict one another — think of a disc wheel. However, at around 1505 grams, and with the lowest drag system on the market, the 46 Aero accomplishes all of the above harmoniously. But, to solidify this, let's get into requirements three and four. This brings us to DET's most impressive characteristic, handling. In relation to the bearing, it's rare to have a real-world circumstance of a straight 180 degree head wind. In reality, you spend 95% of your riding time between 0 and 20 degrees of yaw with a wind angle anywhere from 0 to 100 degrees in relation to the bearing. Accordingly, DET places a focus at improving handling while side force is acting on the wheel. To do so, the DET rim shape pushes the center of pressure forward, beyond the center of mass (hub axle center), for a more stable steering force. For reference, the Firecrest's center of pressure is a little behind the center of mass. But, in the case of DET, the lift and drag vectors are accordingly shifted into a favorable position that extends the range of lift, and as a result, it delays aerodynamic stall (the point where the drag vector is larger than the lift vector) in order to achieve a larger \"sweet spot.\" Why is this important? Well, it creates a more predictable sense of handling, conserves watts, and requires less steering force from the rider. Additionally, the DET shape prevents stall at angles before 20 degrees of yaw, while most competitor's offerings experienced stall between around 12.5 and 14 degrees of yaw. This means that the Aero's handling \"sweet spot\" is extended to a window of 7.5 degrees higher than the competition. You'll also find that DET's center of pressure maximizes the forward thrust vector (a quantity that has direction and magnitude), while the rim shape increases lift and decreases turbulent flow. So, the effective lift-to-drag ratio creates a forward thrust that, basically, requires you to exert less watts to propel the wheel forward. Essentially, this system works almost like a turbine that feeds off of the wind. With the Aero, Reynolds also addressed an all-too-common ailment to carbon wheels — poor braking. The solution was found through the development of what Reynolds calls its Crynogenic Glass Transition Braking System (CTg). Essentially, this is a patented braking design that required both a redesign of the brake track laminate and pads. Accordingly, CTg uses a temperature-conductive laminate at the brake track's transition points that withstands higher levels of heat than typical carbon laminates (around a 100 degree dispersion). And when paired with Reynolds' polymer Cryo Blue brake pads, braking becomes more predictable and requires less finicky feathering on fast descents. The Reynolds 46 Aero Carbon Clincher Road Wheelset is available in the color Black with White labels and in a clincher configuration. Please note that the rear wheel is offered with either a Shimano or Campagnolo 11-speed freehub compatibility. Also, every wheelset includes two pairs of Reynolds Cryo Blue Brake Pads. Reynolds strongly recommends only using its proprietary pads, and the use of any other brake pads will result in a void of your warranty."
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.steepandcheap.com/womens-jackets?pagesize=80"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": 80,
                    "pages": 8
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "http://www.steepandcheap.com/womens-jackets?pagesize=80"
        }

        // Change to be the number of products on the page
        var x = 80;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = "Darrah Insulated Coat - Women's";
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '134.55',
                    url: 'http://www.steepandcheap.com/arcteryx-darrah-insulated-coat-womens?skid=ARC006Y-LMFIZ-L&ti=UExQIENhdDpXb21lbnMgSmFja2V0cyAmIENvYXRzOjE6MTpzYWNDYXQyMTAwMDQ=',
                    image: 'http://content.backcountry.com/images/items/medium/ARC/ARC006Y/LMFIZ.jpg',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = "Crystalline Jacket - Women's";
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '63.98',
                    url: 'http://www.steepandcheap.com/marmot-crystalline-jacket-womens?skid=MAR2204-LIT-L&ti=UExQIENhdDpXb21lbnMgSmFja2V0cyAmIENvYXRzOjE6ODA6c2FjQ2F0MjEwMDA0',
                    image: 'http://content.backcountry.com/images/items/medium/MAR/MAR2204/LIT.jpg',
                    country: 'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
