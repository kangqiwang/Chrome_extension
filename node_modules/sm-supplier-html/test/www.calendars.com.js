var should = require('should');
var Structure = require('../lib/structure.js')

describe('replaceWithwebAddress', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.calendars.com/Canada/Magnificent-Rockies-Wall-Calendar/prod201500003076/?categoryId=cat00704&seoCatId=cat00704"
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Magnificent Rockies Wall Calendar",
                    "price": "13.49",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'http://www.calendars.com/img/p/480/201700004683.jpg',
                    "country": 'us',
                    "description": 'The towering snow-capped peaks dominate the landscape amid crystal clear lakes, meandering rivers and lush green valleys. With Magnificent Rockies 2017 Wall Calendar, you can enjoy the majesty and natural splendor of Canada?s Rocky Mountains throughout the year. Produced via environmentally friendly processes, using chlorine free FSC-certified paper and vegetable-based inks, this beautifully photographed wall calendar includes an additional page featuring smaller grids of the months September to December. This wall calendar is produced in English format.Photography by Michael WheatleySeptember-December 2016 overviewPrevious and next month viewsObserves international holidays and moon phases'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.calendars.com/Obama-Out-of-Office-Wall-Calendar/prod201500001889/"
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Obama Out of Office Wall Calendar",
                    "price": "3.49",
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'http://www.calendars.com/img/p/480/201600003397.jpg',
                    "country": 'us',
                    "description": 'From the debacle that is Obamacare to “transparency” to the fact that nothing is getting done anywhere on the political landscape--the only positive news to come out of Washington in the past eight years is that Obama’s presidency is almost over--for real this time. So, buck up, America! Let’s count down to the bitter end before he begins his permanent vacation from the White House. (...if he hasn’t already. Sure looks like it started back in 2008.)'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.calendars.com/Toys/cat00813/"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": 20,
                    "pages": 18
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })


    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "http://www.calendars.com/Canada/cat00704/?seeAll=true"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(category) {
                var expected = JSON.stringify({
                    "name": "Best Selling Canada Calendars"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "http://www.calendars.com/lp/games-toys/?kw=gamestoys/topnav-6-gamesandtoys"
        }

        // Change to be the number of products on the page
        var x = 20;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'Tiny Headed Kingdom: Twist';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '29.99',
                    url: 'http://www.calendars.com/Big-Cats/Tiny-Headed-Kingdom:-Twist/prod201700018960/?categoryId=cat00174&seoCatId=cat00174',
                    image: 'http://www.calendars.com/img/p/105/201700018960.jpg',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'Harley Quinn Playing Cards';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '6.49',
                    url: 'http://www.calendars.com/Cartoons-|-Comics/Harley-Quinn-Playing-Cards/prod201600008431/?categoryId=cat00046&seoCatId=cat00046',
                    image: 'http://www.calendars.com/img/p/105/201600008431.jpg',
                    country: 'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
