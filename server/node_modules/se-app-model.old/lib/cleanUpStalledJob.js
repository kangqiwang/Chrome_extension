const config = require('../config');
const JobModel = require('../model/job');
const async = require('async');

/*
 * Clean Up Stalled Job
 * - Mark Job As Stalled
 * - Check for Queued Jobs
 */ 
module.exports = (payload, next) => {

    const job = new JobModel(config.mongoDb);
    
    async.waterfall([
        (done) => {
            // Mark Job As Stalled
            job.markJobAsStalled(payload, (err, result) => {
                done(err);
            });
        },
        (done) => {
            // Check for Queued Jobs
            job.getUserQueuedJobs(payload, (err, result) => {
                done(err, result);
            })
        }
    ], (err, result) => {
        next(err, result)        ;
    });    
    
}