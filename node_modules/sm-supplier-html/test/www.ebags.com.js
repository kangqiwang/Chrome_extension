var should = require('should');
var Structure = require('../lib/structure.js')

describe('www.ebags.com', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.ebags.com/product/sony/8gb-max-flash-action-micro-sdhc-class-10/314661?productid=10433206"
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "8GB Max-Flash Action Micro SDHC Class 10",
                    "price": "21.99",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'http://cdn-eu-ec.yottaa.net/54636bb786305e35ea00040e/ca3ea000f77501321219123dfe2baf36.yottaa.net/v~13.d2/is/image/im1/314661_1_1?resmode=4&op_usm=1,1,1,&qlt=80,1&hei=500&wid=500&align=0,1&yocs=_&yoloc=eu',
                    "country": 'us'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.ebags.com/product/solo/urban-universal-tablet-sling/289072?productid=10347817&couponid=94790994&sourceID=COMJFEED&CA_6C15C=120011660001081760"
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Urban Universal Tablet Sling, fits tablets up to 11\"",
                    "price": null,
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": "http://cdn-eu-ec.yottaa.net/54636bb786305e35ea00040e/ca3ea000f77501321219123dfe2baf36.yottaa.net/v~13.e5/is/image/im2/289072_1_1?resmode=4&op_usm=1,1,1,&qlt=80,1&hei=500&wid=500&align=0,1&yocs=2p_2q_&yoloc=eu",
                    "country": "us"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.ebags.com/category/electronics"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": 120,
                    "pages": 8
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

     describe('Not a search page', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.ebags.com/product/ebags/lifejacket-quick-charge-battery-4000mah/310475?productid=10411151"
        }

        it('should return null items and pages', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": null,
                    "pages": null
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "http://www.ebags.com/category/electronics"
        }

        it('should be true when correct category is returned', function (done) {

            Structure(payload, function(category) {
                var expected = JSON.stringify({
                    "name": "Portable Electronics & Accessories"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "http://www.ebags.com/category/electronics"
        }

        // Change to be the number of products on the page
        var x = 120;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'QuietComfortÂ® 35 wireless headphones';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '349.00',
                    url: 'http://www.ebags.com/product/bose/quietcomfort-35-headphones/322886?productid=10469896',
                    image: 'http://cdn-eu-ec.yottaa.net/54636bb786305e35ea00040e/ca3ea000f77501321219123dfe2baf36.yottaa.net/v~13.d2/is/image/im6/322886_1_1?resmode=4&op_usm=1,1,1,&qlt=80,1&hei=280&wid=280&align=0,1&yocs=_&yoloc=eu',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'USB 3.0 7 port Hub - Charge and Sync';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '54.99',
                    url: 'http://www.ebags.com/product/visiontek/usb-30-7-port-hub-charge-and-sync/321553?productid=10465851',
                    image: '//cdn1.ebags.com/is/image/im3/321553_1_1?resmode=4&op_usm=1,1,1,&qlt=80,1&hei=280&wid=280&align=0,1',
                    country: 'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
