var should = require('should');
var Structure = require('../lib/structure.js')
let cache = require('../lib/cache')

describe('www.petsmart.com', function () {

    this.timeout(10000);

    describe('In Stock Page', function () {

        var payload = {
            "pageType": "product",
            "url": "http://www.petsmart.com/cat/beds-blankets/kitty-sill-deluxe-bolster-cat-bed-zid36-5574/cat-36-catid-200009;pgid=MuJwy3eKV9xSRp8vf3cUwx930000jxLhkHn0;sid=44v0bUBIGrb_bRf6Nge0aXBCAICoywU0tJmA-Q3H?var_id=36-5574",
            "html": cache.load("http://www.petsmart.com/cat/beds-blankets/kitty-sill-deluxe-bolster-cat-bed-zid36-5574/cat-36-catid-200009;pgid=MuJwy3eKV9xSRp8vf3cUwx930000jxLhkHn0;sid=44v0bUBIGrb_bRf6Nge0aXBCAICoywU0tJmA-Q3H?var_id=36-5574")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function (err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Kitty Sill Deluxe Bolster Cat Bed",
                    "price": "59.99",
                    "url": payload.url,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'http://petus.imageg.net/PETNA_36/pimg/pPETNA-5172722_main_t300x300.jpg',
                    "country": 'us'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function () {

        var payload = {
            "pageType": "product",
            "url": "http://www.petsmart.com/cat/beds-blankets/grreat-choice-oval-bolster-pet-bed-zid36-22867/cat-36-catid-200009?var_id=36-22867",
            "html": cache.load("http://www.petsmart.com/cat/beds-blankets/grreat-choice-oval-bolster-pet-bed-zid36-22867/cat-36-catid-200009?var_id=36-22867")
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function (err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Grreat Choice® Oval Bolster Pet Bed",
                    "price": "9.99",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'http://petus.imageg.net/PETNA_36/pimg/pPETNA-5216260_main_t300x300.jpg',
                    "country": 'us'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    //   describe('Search Page', function () {

    //       var payload = {
    //           "pageType": "search",
    //           "url": "https://www.petsmart.com/sale/",
    //           "html": cache.load("https://www.petsmart.com/sale/")
    //       }

    // Change to be the number of products on the page
    //       var x = 9;
    //       it('should return ' + x + ' numer of products', function (done) {
    //           Structure(payload, function (err, result) {
    //               result.length.should.equal(x);
    //               done()
    //           })
    //       });

    //       var firstProductName = 'Whisker City® Cozy Kitty Cushioned Window Perch';
    //       it('first product should be ' + firstProductName, function (done) {
    //           Structure(payload, function (err, result) {
    //               var first = result.shift()
    //               var expected = JSON.stringify({
    //                   barcode: null,
    //                   name: firstProductName,
    //                   price: '29.99',
    //                  url: 'http://www.petsmart.com/cat/beds-blankets/whisker-city-cozy-kitty-cushioned-window-perch-zid36-5973/cat-36-catid-200009?var_id=36-5973',
    //                   image: 'http://petus.imageg.net/PETNA_36/pimg/pPETNA-1821808_main_r200.jpg',
    //                   country: 'us'
    //               })
    //               JSON.stringify(first).should.equal(expected)
    //               done()
    //           })

    //       })

    //        var lastProductName = 'Armarkat Pet Bed';
    //        it('last product should be ' + lastProductName, function (done) {
    //            Structure(payload, function (err, result) {
    //                var last = result.pop()
    //                var expected = JSON.stringify({
    //                    barcode: null,
    //                    name: lastProductName,
    //                    price: '28.99',
    //                    url: 'http://www.petsmart.com/cat/beds-blankets/armarkat-pet-bed-zid36-5415/cat-36-catid-200009?var_id=36-5415',
    //                    image: 'http://petus.imageg.net/PETNA_36/pimg/pPETNA-5180887_main_r200.jpg',
    //                   country: 'us'
    //                })

    //                JSON.stringify(last).should.equal(expected)
    //                done()
    //            });
    //        })

    //    });
    describe('Search page pagination', function () {

        var payload = {
            "pageType": "pagination",
            "url": "http://www.petsmart.com/cat/supplies-and-training/bowls-and-feeders/",
            "html": cache.load("http://www.petsmart.com/cat/supplies-and-training/bowls-and-feeders/")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function (err, pagination) {
                var expected = JSON.stringify({
                    "items": 24,
                    "pages": 7,
                    "url": "http://www.petsmart.com/cat/supplies-and-training/bowls-and-feeders/"
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page category', function () {

        var payload = {
            "pageType": "category",
            "url": "http://www.petsmart.com/cat/supplies-and-training/bowls-and-feeders/",
            "html": cache.load("http://www.petsmart.com/cat/supplies-and-training/bowls-and-feeders/")
        }

        it('should be true when the category is correct', function (done) {

            Structure(payload, function (err, category) {
                var expected = JSON.stringify({
                    "name": "Bowls & Feeders",
                    "url": "http://www.petsmart.com/cat/supplies-and-training/bowls-and-feeders/"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

});


describe('New Search Page', function () {

    var payload = {
        "pageType": "search",
        "url": "https://www.petsmart.com/sale/",
        "html": cache.load("https://www.petsmart.com/sale/")
    }

    // Change to be the number of products on the page
    var x = 19;
    it('should return ' + x + ' number of products', function (done) {
        Structure(payload, function (err, result) {
            result.length.should.equal(x);
            done()
        })
    });

    var firstProductName = 'Royal Canin® Veterinary Diet Urinary SO Adult Cat Food';
    it('first product should be ' +firstProductName, function (done) {
        Structure(payload, function (err, result) {
            var first = result.shift()
                first.name.should.be.equal(firstProductName)
                first.price.should.be.equal("1.76") 
                first.url.should.be.equal('https://www.petsmart.com/sale/royal-canin-veterinary-diet-urinary-so-adult-cat-food-1744.html?cgid=sale')
                first.image.should.be.equal('https://s7d2.scene7.com/is/image/PetSmart/5169459?$sclp-prd-main_large$')
                first.country.should.be.equal("us")
                done()
            });    
        })

    var lastProductName = 'Hill\'s® Prescription Diet® Metabolic Weight Management Cat Food - Chicken';
    it('last product should be ' +lastProductName, function (done) {
        Structure(payload, function (err, result) {
            var last = result.pop()
                last.name.should.be.equal(lastProductName)
                last.price.should.be.equal("2.09")
                last.url.should.be.equal('https://www.petsmart.com/sale/hills-prescription-diet-metabolic-weight-management-cat-food---chicken-1714.html?cgid=sale')
                last.image.should.be.equal('https://s7d2.scene7.com/is/image/PetSmart/5197660?$sclp-prd-main_large$')
                last.country.should.be.equal("us")
                done()
            });
        })

    });