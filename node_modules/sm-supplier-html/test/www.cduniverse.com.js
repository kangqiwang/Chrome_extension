var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache.js')

describe('replaceWithwebAddress', function() {


    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.cduniverse.com/productinfo.asp?pid=10479324&style=music"
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Hardwired...To Self-Destruct CD",
                    "price": "14.99",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'http://c3.cduniverse.ws/resized/250x500/music/324/10479324.jpg',
                    "country": 'us',
                    "description": "Metallica began their long journey back home some time after nearly imploding during the recording of 2003's St. Anger. Hardwired... To Self-Destruct arrives 13 years after that album but it, almost more than its 2008 predecessor Death Magnetic, feels like a repudiation of the band's '90s, the years when Metallica shined up, slowed down, and got a lot weirder. ... Full Description Sprawling over two discs when it could've fit onto one (an aesthetic choice certainly meant to evoke memories of 1988's double LP ... And Justice for All), Hardwired... To Self-Destruct does indeed rage, roaring out the gate with a title track where James Hetfield bellows \"We're so f***ed/S*** out of luck.\" That palpable desperation recalls the free-floating angst that fueled Metallica's '80s, but Hardwired... To Self-Destruct doesn\'t find the quartet scrambling to sound as ferocious as they did during their heyday. Often, they do unleash the fury -- \"Moth into Flame\" gallops forward in a manner reminiscent of \"Battery\" -- but there's no denying that Metallica are an older band now, either incapable or uninterested in maintaining that intensity over the course of a full double album. When they slow down, it's not exclusively to churn and brood. \"Murder One,\" a salute to departed Mot√∂rhead leader Lemmy, may belong in that category, but \"Am I Savage?\" teeters between ominous dirge and intricate transitions, while \"Dream No More\" has a backbeat that nearly swings. \"ManUNKind\" also has a bit of buried funk in its rhythms and that, along with the preponderance of complicated suites, is a clue that Hardwired... To Self-Destruct is primarily the work of Hetfield and Lars Ulrich. Kirk Hammett doesn't have a single songwriting credit -- allegedly, this is due to the guitarist losing an iPhone filled with riffs just prior to recording -- and he's also diminished in terms of solos, leaving Hardwired as a showcase for Metallica's musical constructions. If the riffs don't always sink in deeply -- and if the entire production feels slightly monochromatic -- what impresses here is the thought and musicality within the compositions and the performances, elements that have always been at the band's core and shine brightly on Hardwired... To Self-Destruct. ~ Stephen Thomas Erlewine. Hide Description"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.cduniverse.com/productinfo.asp?pid=7241244&style=music"
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "My Lycan Me CD",
                    "price": null,
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'http://c3.cduniverse.ws/resized/250x500/music/244/7241244.jpg',
                    "country": 'us',
                    "description": ''
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.cduniverse.com/browsecat.asp?style=music&refcode=X&cat=58"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": 25,
                    "pages": 1537
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "http://www.cduniverse.com/browsecat.asp?style=music&refcode=X&cat=58"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(category) {
                var expected = JSON.stringify({
                    "name": "Heavy Metal Music CDs : Top Sellers"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType": "search",
            "url": "https://www.cduniverse.com/browsecat.asp?style=music&refcode=X&cat=58",
            "html": cache.load("https://www.cduniverse.com/browsecat.asp?style=music&refcode=X&cat=58")
        }

        var x = 7;
        it('should return ' + x + ' numer of products', function () {
            let result = Structure(payload)
            result.length.should.equal(x);
        });

        var firstProductName = 'Critters Go For A Ride 100 Large Piece Jigsaw Puzzle';
        it('first product should be ' + firstProductName, function() {

            var expected = JSON.stringify({
                barcode: null,
                name: firstProductName,
                price: '4.99',
                url: 'http://www.bitsandpieces.com/product/critters-go-for-a-ride-100-large-piece-jigsaw-puzzle-42777',
                image: 'https://s3.amazonaws.com/cdn.bitsandpieces.com/images/160/42777.jpg',
                country: 'us'
            })
            
            let result = Structure(payload)

            var first = result.shift()
            
            JSON.stringify(first).should.equal(expected)

        })

        var lastProductName = 'Soccer Sliding Wooden Puzzle';
        it('last product should be ' + lastProductName, function () {
            var expected = JSON.stringify({
                barcode: null,
                name: lastProductName,
                price: '14.99',
                url: 'http://www.bitsandpieces.com/product/soccer-sliding-wooden-puzzle',
                image: 'https://s3.amazonaws.com/cdn.bitsandpieces.com/images/160/43952.jpg',
                country: 'us'
            })

            const result = Structure(payload);

            var last = result.pop()
            JSON.stringify(last).should.equal(expected)
        })
    }); 

});
