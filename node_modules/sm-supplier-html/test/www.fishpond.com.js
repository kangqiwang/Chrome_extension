var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')

describe('replaceWithwebAddress', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.fishpond.com/Toys/Pigma-Micron-All-Black-8-Nibs-Set-Sakura/0053482300670",
            "html": cache.load("http://www.fishpond.com/Toys/Pigma-Micron-All-Black-8-Nibs-Set-Sakura/0053482300670")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Pigma Micron All Black 8 Nibs Set",
                    "price": "23.99",
                    "url": "http://www.fishpond.com/Toys/Pigma-Micron-All-Black-8-Nibs-Set-Sakura/0053482300670",
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'http://rcdn-1.fishpond.co.nz/0031/699/420/31425916/1.jpeg',
                    "country": 'us',
                    "description": "SAKURA-Pigma Pen Set. This pen set is ideal for all kinds of sketching inking and illustrating projects. The archival quality ink is waterproof chemical resistant fade resistant bleed free quick drying and pH neutral. There are eight pens each with a different tip size or style (.2mm .25mm .3mm .35mm .45mm .5mm brush and graphic) all have black ink. This package contains one set of eight pens. Acid free. Conforms to ASTM D-4236. Imported.",
                    "sku" : "0053482300670"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.fishpond.com/Toys/Star-Wars-Jedi-Force-Imperial-AT-AT-Walker-with-AT-AT-Driver-Star-Wars/9999689088515",
            "html": cache.load("http://www.fishpond.com/Toys/Star-Wars-Jedi-Force-Imperial-AT-AT-Walker-with-AT-AT-Driver-Star-Wars/9999689088515")
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Star Wars Jedi Force Imperial AT-AT Walker [with AT-AT Driver]",
                    "price": "",
                    "url": "http://www.fishpond.com/Toys/Star-Wars-Jedi-Force-Imperial-AT-AT-Walker-with-AT-AT-Driver-Star-Wars/9999689088515",
                    "inStock": false,
                    "stockLevel": null,
                    "country": 'us',
                    "description": "Product Description:A galaxy full of adventure awaits in Star Wars Jedi Force! The Imperial AT-AT Walker moves across the frozen Hoth landscape toward the rebel base. It is up to the Rebels to defeat this vehicle before it's too late.",
                    "sku": '9999689088515'
                    
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.fishpond.com/Kitchen/?page=5",
            "html": cache.load("http://www.fishpond.com/Kitchen/?page=5")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": 20,
                    "pages": 50,
                    "url": payload.url
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "http://www.fishpond.com/Kitchen/?page=5",
            "html": cache.load("http://www.fishpond.com/Kitchen/?page=5")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, category) {
                var expected = JSON.stringify({
                    "name": "Kitchen",
                    "url": payload.url
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.fishpond.com/Toys/Action_Toy_Figures?page=2",
            "html": cache.load("https://www.fishpond.com/Toys/Action_Toy_Figures?page=2")
        }

        // Change to be the number of products on the page
        var x = 24;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(err, result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'McFarlane Toys Five Nights At Freddy\'s Prize Corner Construction Building Kit';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(err, result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: "0787926126914",
                    name: firstProductName,
                    price: '29.99',
                    url: 'https://www.fishpond.com/Toys/McFarlane-Toys-Five-Nights-At-Freddys-Prize-Corner-Construction-Building-Kit-FIVE-NIGHTS-AT-FREDDYS/0787926126914',
                    image: 'https://cdn1.fishpond.co.nz/0145/281/464/334497841/4.jpeg',
                    country: 'us',
                    sku: '0787926126914'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'Oddbods Fuse Face Changer Figurine';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(err, result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: "5060466940093",
                    name: lastProductName,
                    price: '17.85',
                    url: 'https://www.fishpond.com/Toys/Oddbods-Fuse-Face-Changer-Figurine-Oddbods/5060466940093',
                    image: 'https://cdn1.fishpond.co.nz/0125/196/779/262265079/4.jpeg',
                    country: 'us',
                    sku: '5060466940093'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

         describe('Checking to see if no pagination works', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.fishpond.com/page/about-us-innovation",
            "html": cache.load("http://www.fishpond.com/page/about-us-innovation")
        }

        it('should return 0 items and null pages', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": 0,
                    "pages": null,
                    "url": payload.url
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    });

});
