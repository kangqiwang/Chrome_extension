var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')

describe('www.echemist.co.uk', function() {

    before(function()  {
        this.timeout(5000);
    })

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.echemist.co.uk/product/kent-hairbrush-cleaner-lpc2",
            "html": cache.load("http://www.echemist.co.uk/product/kent-hairbrush-cleaner-lpc2")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Kent Hairbrush Cleaner - LPC2",
                    "price": "2.95",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'http://www.echemist.co.uk/media/product/2131749041.Jpeg',
                    "country": 'uk',
                    "description": "A brush for cleaning hairbrushes. Removes dead hairs suitable for all types of brushes. Regular cleaning of your Kent Hairbrush will not only extend the life of your brush but will help prevent dirty and greasy hair. InstructionsRegularly remove loose hair from the tufts of your brush by inserting a Kent Hair Brush Cleaner at the side of the brush and lifting the hair away. Repeat around the brush but don't scrape the Kent Hair Brush Cleaner through the brush.Wet-clean occasionally using warm, soapy water - never ammonia or harsh detergents. Submerge just the tufts, not the brush back/handle.Rinse off in cold water.Shake off surplus water then wipe gently in a towel. Leave to dry bristle down in the open air, but not in direct sun light. Never dry on a radiator or in a strong, artificial heat.Brush length 150mm width at grip 20mm length of nylon 20mm"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    // describe('Out of Stock Page', function() {

    //     var payload = {
    //         "pageType" : "product",
    //         "url" : "http://www.echemist.co.uk/p-hugo-boss-selection-after-shave-balm"
    //     }

    //     it('should return false when product is out of stock', function(done) {

    //         Structure(payload, function(inStockPage) {
    //             var expected = JSON.stringify({
    //                 "name": "Hugo Boss Selection After Shave Balm",
    //                 "price": null, // price not shown when out of stock
    //                 "url": null,
    //                 "inStock": false,
    //                 "stockLevel": null
    //             })
    //             JSON.stringify(inStockPage).should.equal(expected);
    //             done()
    //         })
    //     })

    // })

 describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.echemist.co.uk/category/online-beauty/beauty-skin?pagenumber=2",
            "html": cache.load("http://www.echemist.co.uk/category/online-beauty/beauty-skin?pagenumber=2")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": 72,
                    "pages": 20
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

  describe('Not a search page', function() {

     var payload = {
         "pageType" : "pagination",
         "url" : "http://www.echemist.co.uk/product/healthaid-nurideen-vitamin-c-zinc-silica-marine-fish-extract",
         "html": cache.load("http://www.echemist.co.uk/product/healthaid-nurideen-vitamin-c-zinc-silica-marine-fish-extract")
     }

     it('should return null items and pages', function (done) {

         Structure(payload, function(err, pagination) {
             var expected = JSON.stringify({
                 "items": null,
                 "pages": null
             })
             JSON.stringify(pagination).should.equal(expected);
             done()
         })
     });

 });

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "http://www.echemist.co.uk/category/online-beauty/beauty-skin?pagenumber=2",
            "html": cache.load("http://www.echemist.co.uk/category/online-beauty/beauty-skin?pagenumber=2")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, category) {
                var expected = JSON.stringify({
                    "name": "Skin"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.echemist.co.uk/category/online-pharmacy/pharmacy-hair-body/pharmacy-hair-body-head-lice",
            "html": cache.load("https://www.echemist.co.uk/category/online-pharmacy/pharmacy-hair-body/pharmacy-hair-body-head-lice")
        }

        // Change to be the number of products on the page
        var x = 18;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(err, result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'HealthAid Nurideen (Vitamin C, Zinc, Silica, Marine Fish Extract)';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(err, result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '23.99',
                    url: 'http://www.echemist.co.uk/product/healthaid-nurideen-vitamin-c-zinc-silica-marine-fish-extract',
                    image: 'http://www.echemist.co.uk//media/product/healthaid-nurideen-vitamin-c-zinc-silica-marine-fish-extract.jpg',
                    country: 'uk'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = "L'Oreal Paris Dermo-Expertise Revitalift Deep-Set Wrinkles";
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(err, result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '10.99',
                    url: 'http://www.echemist.co.uk/product/loreal-revitalift-deep-set-wrinkles',
                    image: 'http://www.echemist.co.uk//media/product/loreal-revitalift-deep-set-wrinkles2.jpg',
                    country: 'uk'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});

