var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache.js')

describe('www.webstaurantstore.com', function () {


    describe('Search Page', function () {

        var payload = {
            "pageType": "search",
            "url": "https://www.webstaurantstore.com/50387/get-bambooserve-dinnerware.html",
            "html": cache.load("https://www.webstaurantstore.com/50387/get-bambooserve-dinnerware.html")
        }

        var x = 7;
        it('should return ' + x + ' numer of products', function () {
            let result = Structure(payload)
            result.length.should.equal(x);
        });

        var firstProductName = 'Critters Go For A Ride 100 Large Piece Jigsaw Puzzle';
        it('first product should be ' + firstProductName, function() {

            var expected = JSON.stringify({
                barcode: null,
                name: firstProductName,
                price: '4.99',
                url: 'http://www.bitsandpieces.com/product/critters-go-for-a-ride-100-large-piece-jigsaw-puzzle-42777',
                image: 'https://s3.amazonaws.com/cdn.bitsandpieces.com/images/160/42777.jpg',
                country: 'us'
            })
            
            let result = Structure(payload)

            var first = result.shift()
            
            JSON.stringify(first).should.equal(expected)

        })

        var lastProductName = 'Soccer Sliding Wooden Puzzle';
        it('last product should be ' + lastProductName, function () {
            var expected = JSON.stringify({
                barcode: null,
                name: lastProductName,
                price: '14.99',
                url: 'http://www.bitsandpieces.com/product/soccer-sliding-wooden-puzzle',
                image: 'https://s3.amazonaws.com/cdn.bitsandpieces.com/images/160/43952.jpg',
                country: 'us'
            })

            const result = Structure(payload);

            var last = result.pop()
            JSON.stringify(last).should.equal(expected)
        })
    }); 

    describe('Search Page with missing Prices', function () {

        var payload = {
            "pageType": "search",
            "url": "https://www.webstaurantstore.com/52705/reach-in-refrigerators.html",
            "html": cache.load("https://www.webstaurantstore.com/52705/reach-in-refrigerators.html")
        }

        it('should return 10 products', function (done) {
            Structure(payload, function (err, result) {
                result.length.should.equal(10);
                done()
            })
        });



        it('first product should be a Avantco SS-2R-HC 54\" Solid Door Reach-In Refrigerator', function (done) {
            Structure(payload, function (err, result) {
                result[0].name.should.be.equal("Avantco SS-2R-HC 54\" Solid Door Reach-In Refrigerator")
                result[0].price.should.be.equal("2159.00")
                result[0].url.should.be.equal("https://www.webstaurantstore.com/avantco-ss-2r-hc-54-solid-door-reach-in-refrigerator/178SS2RHC.html")
                result[0].image.should.be.equal("https://cdnimg.webstaurantstore.com/images/products/medium/228779/1268920.jpg")
                result[0].sku.should.be.equal("178SS2RHC")
                done()
            })
        })

        it('last product should be a Avantco SS-1R-2-HC 29\" Stainless Steel Solid Half Door Reach-In Refrigerator', function (done) {

            Structure(payload, function (err, result) {
                    var last = result.pop()
                    last.name.should.be.equal("Avantco SS-1R-2-HC 29\" Stainless Steel Solid Half Door Reach-In Refrigerator")
                    last.price.should.be.equal("1699.00")
                    last.url.should.be.equal("https://www.webstaurantstore.com/avantco-ss-1r-2-hc-29-stainless-steel-solid-half-door-reach-in-refrigerator/178SS1R2HC.html")
                    last.image.should.be.equal("https://cdnimg.webstaurantstore.com/images/products/medium/393164/1524720.jpg")
                    last.sku.should.be.equal("178SS1R2HC")
                    done()
                });
            })

    })


    describe('Search Page with missing Prices like XXX.XX', function () {
        
                var payload = {
                    "pageType": "search",
                    "url": "https://www.webstaurantstore.com/13957/commercial-coffee-makers-brewers-automatic.html",
                    "html": cache.load("https://www.webstaurantstore.com/13957/commercial-coffee-makers-brewers-automatic.html")
                }
        
                it('should return 46 products', function (done) {
                    Structure(payload, function (err, result) {
                        result.length.should.equal(46);
                        done()
                    })
                });
        
        
        
                it('first product should be a Bunn 35700.0001 ITCB-DV Infusion Tea and Coffee Brewer with 25 3/4 Trunk - Dual Voltage', function (done) {
                    Structure(payload, function (err, result) {
                        result[0].name.should.be.equal('Bunn 35700.0001 ITCB-DV Infusion Tea and Coffee Brewer with 25 3/4" Trunk - Dual Voltage')
                        result[0].price.should.be.equal("837.50")
                        result[0].url.should.be.equal("https://www.webstaurantstore.com/bunn-35700-0001-itcb-dv-infusion-tea-and-coffee-brewer-with-25-3-4-trunk-dual-voltage/234357000001.html")
                        result[0].image.should.be.equal("https://cdnimg.webstaurantstore.com/images/products/medium/38429/5695.jpg")
                        result[0].sku.should.be.equal("234357000001")
                        done()
                    })
                })
        
                it('last product should be a Fetco CBS-1132V+ E113251 Extractor V+ Series Stainless Steel Twin Automatic Coffee Brewer - 240V', function (done) {
        
                    Structure(payload, function (err, result) {
                            var last = result.pop()
                            last.name.should.be.equal("Fetco CBS-1132V+ E113251 Extractor V+ Series Stainless Steel Twin Automatic Coffee Brewer - 240V")
                            last.price.should.be.equal("939.00")
                            last.url.should.be.equal("https://www.webstaurantstore.com/fetco-cbs-1132v-e113251-extractor-v-series-stainless-steel-twin-automatic-coffee-brewer-240v/344CBS113251.html") 
                            last.image.should.be.equal("https://cdnimg.webstaurantstore.com/images/products/medium/433473/1601677.jpg")
                            last.sku.should.be.equal("344CBS113251")
                            done()
                        });
                    })
        
            })

    



        describe('In Stock Page', function () {

            var payload = {
                "pageType": "product",
                "url": "https://www.webstaurantstore.com/tuxton-bbm-1202-duratux-black-12-oz-china-c-handle-mug-24-case/303CHM12BK.html",
                "html": cache.load("https://www.webstaurantstore.com/tuxton-bbm-1202-duratux-black-12-oz-china-c-handle-mug-24-case/303CHM12BK.html")
            }

            it('should be true when product is in stock', function (done) {

                Structure(payload, function (err, inStockPage) {

                    inStockPage.name.should.be.equal("Tuxton BBM-1202 DuraTux Black 12 oz. China C-Handle Mug - 24/Case")
                    inStockPage.price.should.be.equal("90.93")
                    inStockPage.inStock.should.be.equal(true)

                    done()
                })
            });

        });



        // describe('Out of Stock Page', function() {

        //     var payload = {
        //         "pageType" : "product",
        //         "url" : ""
        //     }

        //     it('should return false when product is out of stock', function(done) {

        //         Structure(payload, function(inStockPage) {
        //             var expected = JSON.stringify({
        //                 "name": "",
        //                 "price": "",
        //                 "url": null,
        //                 "inStock": false,
        //                 "stockLevel": null
        //             })
        //             JSON.stringify(inStockPage).should.equal(expected);
        //             done()
        //         })
        //     })

        // })

        //   describe('Search page pagination', function() {

        //     var payload = {
        //         "pageType" : "pagination",
        //         "url" : "http://www.webstaurantstore.com/50387/get-bambooserve-dinnerware.html"
        //     }

        //     it('should be true when number of items and pages correct', function (done) {

        //         Structure(payload, function(pagination) {
        //             var expected = JSON.stringify({
        //                 "items": 0,
        //                 "pages": 0
        //             })
        //             JSON.stringify(pagination).should.equal(expected);
        //             done()
        //         })
        //     });

        // });

        describe('Search page category', function () {

            var payload = {
                "pageType": "category",
                "url": "https://www.webstaurantstore.com/50387/get-bambooserve-dinnerware.html",
                "html": cache.load("https://www.webstaurantstore.com/50387/get-bambooserve-dinnerware.html")
            }

            it('should be true when the category is correct', function (done) {

                Structure(payload, function (err, category) {
                    category.name.should.be.equal("GET BambooServe Dinnerware")
                    done()
                })
            });

        });

    });
