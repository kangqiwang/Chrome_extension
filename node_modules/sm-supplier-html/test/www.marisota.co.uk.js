var should = require('should');
var Structure = require('../lib/structure.js')

describe('www.marisota.co.uk', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.marisota.co.uk/shop/single-breasted-coat/je965/product/details/show.action?pdBoUid=4484#colour:,size:"
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Single Breasted Coat",
                    "price": "69.00",
                    "url": null,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'http://productimages.drct2u.com/main_product/products/je/je965/l01je965500a.jpg',
                    "country": 'uk',
                    "description": 'A classic for your wardrobe in a choice of elegant camel or black. Wear with smart trousers or team with jeans for a more casual look. Fully lined. Length 37in/94cm. Machine washable. Polyester. Lining: Polyester. Product available in sizes: 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32 Available in: Black, Camel'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.marisota.co.uk/shop/cry-babies-lea/dy220/product/details/show.action?pdBoUid=4703#colour:,size:"
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(inStockPage) {
                var expected = JSON.stringify({
                    "name": "Cry Babies - LEA",
                    "price": "30.00",
                    "url": null,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'http://productimages.drct2u.com/main_product/products/dy/dy220/k16dy220501s.jpg',
                    "country": 'uk',
                    "description": 'Poor little Cry Baby Lea! Give her the dummy and a cuddle to stop her from crying. She cries real water, makes baby noises and come with a special packet of tissues for mopping up those tears! For more play fun, arms and legs are movable. She also comes with her own changeable animal print onesie! 3 different Cry Babies to collect - Lea, Coney and Lala. Requires 2 x AAA batteries (included). Ages from 3 years. L.23.5 x W.14 x H.28.5cm.'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.marisota.co.uk/shop/coats-jackets/fashion/1/_/N-1ytvt7u/products/show.action?Rpp=48&hnid=11195083&sdd=true&spv=true&type=cmr"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(pagination) {
                var expected = JSON.stringify({
                    "items": 48,
                    "pages": 5
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "http://www.marisota.co.uk/shop/coats-jackets/fashion/1/_/N-1ytvt7u/products/show.action?Rpp=48&hnid=11195083&sdd=true&spv=true&type=cmr"
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(category) {
                var expected = JSON.stringify({
                    "name": "Coats & Jackets"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "http://www.marisota.co.uk/shop/coats-jackets/fashion/1/_/N-1ytvt7u/products/show.action?Rpp=48&hnid=11195083&sdd=true&spv=true&type=cmr"
        }

        // Change to be the number of products on the page
        var x = 48;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'Waxy Parka';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '75.00',
                    url: 'http://www.marisota.co.uk/shop/waxy-parka/jc749/product/details/show.action?pdBoUid=4484',
                    image: 'http://productimages.drct2u.com/plp_full_width_1/products/jc/jc749/l01jc749500a.jpg',
                    country: 'uk'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'Waterfall PU Jacket';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '27.50',
                    url: 'http://www.marisota.co.uk/shop/waterfall-pu-jacket/tk673/product/details/show.action?pdBoUid=4484',
                    image: 'http://productimages.drct2u.com/plp_full_width_1/products/tk/tk673/i01tk673500w.jpg',
                    country: 'uk'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
