const should = require('should');
const expect = require('chai').expect;

const ProductModel = require('../index.js').model.product;
const config = require('../config').es;
const moment = require('moment');

//const util = require('util');

/*
Needs to return data in this format:

{ total: 8875884,
  records: {},
  aggs:
   { amazonCategory:
      { name: 'amazonCategory',
        records:
         { unknown: { name: 'unknown', total: 253 },
           sports_display_on_website: { name: 'sports_display_on_website', total: 153 },
           toy_display_on_website: { name: 'toy_display_on_website', total: 135 },
           home_improvement_display_on_website: { name: 'home_improvement_display_on_website', total: 122 },
           home_garden_display_on_website: { name: 'home_garden_display_on_website', total: 106 },
           lawn_and_garden_display_on_website: { name: 'lawn_and_garden_display_on_website', total: 64 },
           kitchen_display_on_website: { name: 'kitchen_display_on_website', total: 60 },
           automotive_display_on_website: { name: 'automotive_display_on_website', total: 49 },
           furniture_display_on_website: { name: 'furniture_display_on_website', total: 47 },
           health_and_beauty_display_on_website: { name: 'health_and_beauty_display_on_website', total: 46 } } } },
  timeStamp: '2017-11-01T14:29:38.642Z' }

//OLD Record Structure Below:
 '58c11dee0ee61f2cedbdc302':
      { amazonId: 'music_display_on_website',
        name: 'Music',
        total: '7374695',
        country: 'us',
        type: 'CATEGORY_SAVE',
        userName: 'mike',
        userId: '585d5951cc787451ccefab7e',
        iconClass: 'Music',
        id: 58c11dee0ee61f2cedbdc302 }
*/

describe('Get Amazon Categories', function () {

    this.timeout(10000);

    let payload;
    let Product;

    beforeEach(() => {
        payload = {
            redis: {
                host: 'localhost',
                port: '6379'
            },
            cacheAgeValue: 1,
            cacheAgeUnits: 'minutes',
            country: 'uk'
        };
        Product = new ProductModel(config, 'us');
    });

    it('should return the amazon categories', function (done) {
        Product.getAmazonCategories(payload, (err, result) => {
            should(err).be.equal(null);
            //console.log(util.inspect(result, { showHidden: false, depth: null }));
            expect(result).to.be.an('Object');
            expect(result).to.have.property('total');
            expect(result).to.have.property('aggs');
            expect(result).to.have.property('timeStamp');
            //expect(result.total).to.be.above(0);

            expect(Object.keys(result.aggs).length).to.be.above(0);
            done();
        });
    });

    it('should add a timestamp to the data indicating cache age', (done) => {
        Product.getAmazonCategories(payload, (err, result) => {
            expect(result).to.have.property('timeStamp');
            let timeDiff = moment().diff(result.timeStamp, 'minutes');
            expect(timeDiff).to.be.below(3);
            done();
        });
    });

});
