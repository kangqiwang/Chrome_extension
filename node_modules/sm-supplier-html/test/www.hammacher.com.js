var should = require('should');
var Structure = require('../lib/structure.js')
let cache = require('../lib/cache')

describe('replaceWithwebAddress', function() {

    this.timeout(10000);

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.hammacher.com/Product/Default.aspx?sku=83475&promo=Toys-Games-Classic-Toys&catid=246",
            "html" : cache.load("http://www.hammacher.com/Product/Default.aspx?sku=83475&promo=Toys-Games-Classic-Toys&catid=246")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": 'The 18" Talk Back Mimicking Tomcat.',
                    "price": "49.95",
                    "url": payload.url,
                    "inStock": true,
                    "stockLevel": null,
                    "image": 'http://digital.hammacher.com/Items/83475/83475_380x380.jpg',
                    "country": 'us',
                    "description": 'This is the 18" tall plush Tomcat that repeats anything said to it in a cartoonish voice. Available only from Hammacher Schlemmer, the Tomcat is inspired by a popular smartphone app and a press of his paw enables him to record anything he hears and mimic the speaker in a high-pitched voice. Touch sensors located in his foot and belly yield grunts, whines, and purrs when pressed, just like the app. If his smart mouth offends, repeatedly tapping the top of his head produces bonking sounds until he is coldcocked into unconsciousness with the sound of chirping birds and a coo-coo clock. Requires three AAA batteries. 18" H x 10" W x 9" D. (2 lbs.)'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    // describe('Out of Stock Page', function() {

    //     var payload = {
    //         "pageType" : "product",
    //         "url" : ""
    //     }

    //     it('should be false when product is in store only', function (done) {

    //         Structure(payload, function(inStockPage) {
    //             var expected = JSON.stringify({
    //                 "name": "",
    //                 "price": "",
    //                 "url": null,
    //                 "inStock": false,
    //                 "stockLevel": null,
    //                 "image": '',
    //                 "country": '',
    //                 "description": ''
    //             })
    //             JSON.stringify(inStockPage).should.equal(expected);
    //             done()
    //         })
    //     });

    // });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.hammacher.com/Category/Toys-Games-Classic-Toys?promo=topnav_toys_classic_toys",
            "html" : cache.load("http://www.hammacher.com/Category/Toys-Games-Classic-Toys?promo=topnav_toys_classic_toys")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": 32,
                    "pages": 3,
                    "url" : "http://www.hammacher.com/Category/Toys-Games-Classic-Toys?promo=topnav_toys_classic_toys"
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "http://www.hammacher.com/Category/Toys-Games-Classic-Toys?promo=topnav_toys_classic_toys",
            "html" : cache.load("http://www.hammacher.com/Category/Toys-Games-Classic-Toys?promo=topnav_toys_classic_toys")
        }

        it('should be true when correct category is returned', function (done) {

            Structure(payload, function(err, category) {
                var expected = JSON.stringify({
                    "name": "Classic Toys",
                    "url" : "http://www.hammacher.com/Category/Toys-Games-Classic-Toys?promo=topnav_toys_classic_toys"
                    
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });


    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.hammacher.com/Category/Electronics-iPad-Accessories?promo=topnav_elec_ipad",
            "html" : cache.load("https://www.hammacher.com/Category/Electronics-iPad-Accessories?promo=topnav_elec_ipad")
        }

        // Change to be the number of products on the page
        var x = 18;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(err, result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'The 7 Device Charging Station';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(err, result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '99.95',
                    url: 'http://www.hammacher.com/Product/Default.aspx?sku=90701&promo=Electronics-iPad-Accessories',
                    image: 'https://digital.hammacher.com/Items/90701/90701_170x170.jpg',
                    country: 'us'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'The Immersive Audiophile Pod';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(err, result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '32000.00',
                    url: 'http://www.hammacher.com/Product/Default.aspx?sku=12484&promo=Electronics-iPad-Accessories',
                    image: 'https://digital.hammacher.com/Items/12484/12484_170x170.jpg',
                    country: 'us'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});
