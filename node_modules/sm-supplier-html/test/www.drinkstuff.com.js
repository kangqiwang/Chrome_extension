var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')

describe('replaceWithwebAddress', function() {

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.drinkstuff.com/products/product.asp?ID=5872&catID=266&name=Arc+Broc+Jug+35%2E2oz+%2F+1ltr#.Vx-YzNIrLcs",
            "html" :cache.load("http://www.drinkstuff.com/products/product.asp?ID=5872&catID=266&name=Arc+Broc+Jug+35%2E2oz+%2F+1ltr#.Vx-YzNIrLcs")
        }

        it('should be true when product is in stock', function () {
            
            const inStockPage =  Structure(payload)            
            inStockPage.name.should.be.equal("Money Maze Bank");
            inStockPage.price.should.be.equal("14.99");
            inStockPage.url.should.be.equal("https://www.bitsandpieces.com/product/money-maze-bank");
            inStockPage.inStock.should.be.equal(true);
            should(inStockPage.stockLevel).be.equal(null);
            inStockPage.inStock.should.be.equal(true);
            inStockPage.image.should.be.equal('https://s3.amazonaws.com/cdn.bitsandpieces.com/images/395/42768.jpg');
            inStockPage.country.should.be.equal('us');            
         });
 
    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.drinkstuff.com/products/product.asp?ID=6065",
            "html" :cache.load("http://www.drinkstuff.com/products/product.asp?ID=6065")
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Port Sippers",
                    "price": "6.99",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'https://www.drinkstuff.com/productimg/120978.jpg',
                    "country": 'uk',
                    "description": 'The original Port Sipper was made in the shape of a cigar pipe out of ceramic back in the late 1700s. Today the bar@drinkstuff Port Sippers are made out of glass which brings out the natural and full flavour of the Port so you can enjoy it at its best.A great addition to your glassware collection, whether you need extra glasses for your Port Sipper Set or simply want to expand your collection. They provide a useful and elegant gift.',
                    "sku":"6065"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });


    describe('Discontinued page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.drinkstuff.com/products/product.asp?ID=15709#.V8fwDHUrL0p",
            "html" :cache.load("http://www.drinkstuff.com/products/product.asp?ID=15709#.V8fwDHUrL0p")
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Entertain Butter Pats",
                    "price": "",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'https://www.drinkstuff.com/productimg/111691.jpg',
                    "country": 'uk',
                    "description": 'Perfect for a breakfast service, these butter pads hold an individual serving of butter. Made from a high quality glass and designed to be durable and functional, these butter pads are ideal for everyday use.',
                    "sku": '15709'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.drinkstuff.com/products/kitchen-accessories.asp",
            "html" : cache.load("http://www.drinkstuff.com/products/kitchen-accessories.asp")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": 40,
                    "pages": 1,
                    "url":"http://www.drinkstuff.com/products/kitchen-accessories.asp"
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

     describe('Not a search page', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.drinkstuff.com/products/product.asp?ID=20995&catID=726&name=3+Compartment+Cereal+Dispenser#.WLgSKHWLT0o",
            "html" : cache.load("http://www.drinkstuff.com/products/product.asp?ID=20995&catID=726&name=3+Compartment+Cereal+Dispenser#.WLgSKHWLT0o")
        }

        it('should return null items and pages', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": 0,
                    "pages": null,
                    "url":"http://www.drinkstuff.com/products/product.asp?ID=20995&catID=726&name=3+Compartment+Cereal+Dispenser#.WLgSKHWLT0o"
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    });

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "http://www.drinkstuff.com/products/branded-beer-glasses.asp",
            "html" : cache.load("http://www.drinkstuff.com/products/branded-beer-glasses.asp")

        }

        it('should be true when correct category is returned', function (done) {

            Structure(payload, function(err, category) {
                var expected = JSON.stringify({
                    "name": "Branded Beer Glasses",
                    "url": payload.url
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.drinkstuff.com/products/cocktail-sets.asp",
            "html" : cache.load("https://www.drinkstuff.com/products/cocktail-sets.asp")
        }

        // Change to be the number of products on the page
        var x = 7;
        it('should return ' + x + ' numer of products', function () {
            let result = Structure(payload)
            result.length.should.equal(x);
        });

        var firstProductName = 'Critters Go For A Ride 100 Large Piece Jigsaw Puzzle';
        it('first product should be ' + firstProductName, function() {

            var expected = JSON.stringify({
                barcode: null,
                name: firstProductName,
                price: '4.99',
                url: 'http://www.bitsandpieces.com/product/critters-go-for-a-ride-100-large-piece-jigsaw-puzzle-42777',
                image: 'https://s3.amazonaws.com/cdn.bitsandpieces.com/images/160/42777.jpg',
                country: 'us'
            })
            
            let result = Structure(payload)

            var first = result.shift()
            
            JSON.stringify(first).should.equal(expected)

        })

        var lastProductName = 'Soccer Sliding Wooden Puzzle';
        it('last product should be ' + lastProductName, function () {
            var expected = JSON.stringify({
                barcode: null,
                name: lastProductName,
                price: '14.99',
                url: 'http://www.bitsandpieces.com/product/soccer-sliding-wooden-puzzle',
                image: 'https://s3.amazonaws.com/cdn.bitsandpieces.com/images/160/43952.jpg',
                country: 'us'
            })

            const result = Structure(payload);

            var last = result.pop()
            JSON.stringify(last).should.equal(expected)
        })

    }); 

});
