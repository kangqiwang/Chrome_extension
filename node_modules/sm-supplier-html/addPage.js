var structureHtml = require('./lib/usage.js')('node addPage.js fileName url');
var md5 = require('md5');
var md5FileName = md5(structureHtml.url) + '.html';
var fs = require('fs-extra');
var async = require('async');
var url = require('url');

async.waterfall([
    function(done) {
        fs.rename(structureHtml.fileName, __dirname + '/downloadedPages/' + md5FileName, function(err) {
            done(err)
        })
    },
    function(done) {
        var parseUrl = url.parse(structureHtml.url);
        var payload = {};
        payload.domain = parseUrl.host;
        done(null, payload)
    },
    function(payload, done) {
        payload.logicPath = __dirname + '/suppliers/' + payload.domain + '/';
        fs.mkdir(payload.logicPath, function(err) {
            if(err && err.code === 'EEXIST') {
                err = null
            }
            console.log('Suppliers Directory Created');
            done(err, payload)
        })
    },
    function(payload, done) {
        payload.logicFile = payload.logicPath + '/logic.js';
        payload.exists = false

        fs.exists(payload.logicFile, function(exists) {
            if(exists) {
                done('Supplier Files Already Exist')
            } else {
                done(null, payload)
            }
        })
    },
    function(payload, done) {
        fs.copy(__dirname + '/templates/logic.js', payload.logicFile, function(err) {
            console.log('Copy Logic File');
            done(err, payload)
        })
    },
    function(payload, done) {
        fs.copy(__dirname + '/templates/test.js', __dirname + '/test/' + payload.domain + '.js', function(err) {
            console.log('Copy Test File');
            done(err, payload)
        })
    }
    ], function(err) {
        if(err) {
            console.log(err)
        }
    })




