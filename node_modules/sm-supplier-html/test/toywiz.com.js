var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')

describe('replaceWithwebAddress', function() {

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://toywiz.com/dc-comics-suicide-squad-multiverse-ultimate-croc-series-the-joker-exclusive-action-figure-silver-sportscoat/",
            "html" : cache.load("https://toywiz.com/dc-comics-suicide-squad-multiverse-ultimate-croc-series-the-joker-exclusive-action-figure-silver-sportscoat/")
        }

        it('should be true when product is in stock', function () {
            
            const inStockPage =  Structure(payload)            
            inStockPage.name.should.be.equal("Money Maze Bank");
            inStockPage.price.should.be.equal("14.99");
            inStockPage.url.should.be.equal("https://www.bitsandpieces.com/product/money-maze-bank");
            inStockPage.inStock.should.be.equal(true);
            should(inStockPage.stockLevel).be.equal(null);
            inStockPage.inStock.should.be.equal(true);
            inStockPage.image.should.be.equal('https://s3.amazonaws.com/cdn.bitsandpieces.com/images/395/42768.jpg');
            inStockPage.country.should.be.equal('us');            
         });
 
    });


    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://toywiz.com/dc-comics-suicide-squad-multiverse-croc-series-the-joker-action-figure-purple-jacket/",
            "html" : cache.load("https://toywiz.com/dc-comics-suicide-squad-multiverse-croc-series-the-joker-action-figure-purple-jacket/")
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "DC Comics Suicide Squad Multiverse Croc Series The Joker Action Figure [Purple Jacket]",
                    "price": "24.99",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'https://cdn6.bigcommerce.com/s-0kvv9/images/stencil/500x659/products/139199/194158/suicidejoker__67828.1471601604.jpg?c=2',
                    "country": 'us',
                    "description": "Inspired by the new Suicide Squad movie, this compelling 6-inch figure features 18+ powerful points of articulation and true to movie details. It also comes with a Collect and Connect bonus piece that, when added to other figures pieces, creates a 7-inch Killer Croc figure! You can also choose Deadshot, Boomerang, Katana and Harley Quinn and others to recreate the movie's epic mayhem and new crime fighting thrills.    6-inch figure from the new movie Suicide Squad.    Richly authentic with true to movie details    18+ powerful points of articulation to wage major mayhem.    Includes Collect and Connect bonus leg piece that, when added to other figures pieces, creates a 7-inch Killer Croc figure!    Full series includes Batman, The Joker, Deadshot, Boomerang, Katana and Harley Quinn."
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Low Quantity Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://toywiz.com/dc-suicide-squad-original-minis-mystery-pack/",
            "html" : cache.load("https://toywiz.com/dc-suicide-squad-original-minis-mystery-pack/")
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "DC Suicide Squad Original Minis Mystery Pack",
                    "price": "4.98",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'https://cdn6.bigcommerce.com/s-0kvv9/images/stencil/500x659/products/139009/193785/api90agdh__86959.1471294279.jpg?c=2',
                    "country": 'us',
                    "description": 'Collect all 9!'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });


    describe('Pre Order Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://toywiz.com/suicide-squad-finders-keypers-the-joker-10-inch-statue-pre-order-ships-november/",
            "html" : cache.load("https://toywiz.com/suicide-squad-finders-keypers-the-joker-10-inch-statue-pre-order-ships-november/")
        }

        it('should be false when product is in store only', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Suicide Squad Finders Keypers The Joker 10-Inch Statue (Pre-Order ships January)",
                    "price": "29.99",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": 'https://cdn6.bigcommerce.com/s-0kvv9/images/stencil/500x659/products/132303/183055/jun162467__98669.1465623489.jpg?c=2',
                    "country": 'us',
                    "description": 'The Suicide Squad Finders Keypers will give you a really cool place to store your keys. These 10" statues are plastic and feature a removable key chain that nests in the base. Ridiculously highly detailed, with exceptional attention to likeness and paint, you can\'t hardly get anything this awesome for this price. And it watches over your keys! Choose from The Joker, Harley Quinn, the Batmobile, or Panda!'
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });


    describe('Search page pagination', function() {

        var payload = {
            "pageType" : "pagination",
            "url" : "https://toywiz.com/search.php?search_query=%22ToyWiz%2BPre-Order%22&sort=newest&section=product&page=1",
            "html" : cache.load("https://toywiz.com/search.php?search_query=%22ToyWiz%2BPre-Order%22&sort=newest&section=product&page=1")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": 60,
                    "pages": 19,
                    "url" : "https://toywiz.com/search.php?search_query=%22ToyWiz%2BPre-Order%22&sort=newest&section=product&page=1"
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://toywiz.com/lego/architecture/",
            "html" : cache.load("https://toywiz.com/lego/architecture/")
        }

        // Change to be the number of products on the page
        var x = 7;
        it('should return ' + x + ' numer of products', function () {
            let result = Structure(payload)
            result.length.should.equal(x);
        });

        var firstProductName = 'Critters Go For A Ride 100 Large Piece Jigsaw Puzzle';
        it('first product should be ' + firstProductName, function() {

            var expected = JSON.stringify({
                barcode: null,
                name: firstProductName,
                price: '4.99',
                url: 'http://www.bitsandpieces.com/product/critters-go-for-a-ride-100-large-piece-jigsaw-puzzle-42777',
                image: 'https://s3.amazonaws.com/cdn.bitsandpieces.com/images/160/42777.jpg',
                country: 'us'
            })
            
            let result = Structure(payload)

            var first = result.shift()
            
            JSON.stringify(first).should.equal(expected)

        })

        var lastProductName = 'Soccer Sliding Wooden Puzzle';
        it('last product should be ' + lastProductName, function () {
            var expected = JSON.stringify({
                barcode: null,
                name: lastProductName,
                price: '14.99',
                url: 'http://www.bitsandpieces.com/product/soccer-sliding-wooden-puzzle',
                image: 'https://s3.amazonaws.com/cdn.bitsandpieces.com/images/160/43952.jpg',
                country: 'us'
            })

            const result = Structure(payload);

            var last = result.pop()
            JSON.stringify(last).should.equal(expected)
        })

    });

});

 describe('Search page category', function() {

    var payload = {
        "pageType" : "category",
        "url" : "https://toywiz.com/search.php?search_query=%22ToyWiz%2BPre-Order%22&sort=newest&section=product&page=1",
        "html" : cache.load("https://toywiz.com/search.php?search_query=%22ToyWiz%2BPre-Order%22&sort=newest&section=product&page=1")
    }

    it('should be true when number of items and pages correct', function (done) {

        Structure(payload, function(err, category) {
            var expected = JSON.stringify({
                "name": "ToyWiz Pre-Order",
                "url" : "https://toywiz.com/search.php?search_query=%22ToyWiz%2BPre-Order%22&sort=newest&section=product&page=1"
            })
            JSON.stringify(category).should.equal(expected);
            done()
        })
    });

});