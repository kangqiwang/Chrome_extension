var should = require('should');
var Structure = require('../lib/structure.js')
const cache = require('../lib/cache')

describe('www.shop4world.com', function() {

    before(function()  {
        this.timeout(5000);
    })

    describe('In Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.shop4world.com/torches/2aa-splashproof-soft-touch-rubber-torch-blue",
            "html" : cache.load("http://www.shop4world.com/torches/2aa-splashproof-soft-touch-rubber-torch-blue")
        }

        it('should be true when product is in stock', function (done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "2AA Splashproof Soft Touch Rubber Torch Blue",
                    "price": "6.99",
                    "url": payload.url,
                    "inStock": true,
                    "stockLevel": null,
                    "image": "http://img.shop4world.com/gifts/gadgets/lighting/torches/2aa_splashproof_soft_touch_rubber_torch_blue_xl.jpg",
                    "country": "uk",
                    "description": "Product Features: Ideal for home, car, outdoor, leisure and emergency use Soft touch rubber feel for comfortable grip Extra bright F8 LED Practical hanging strap 2x AA batteries included"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        });

    });

    describe('Out of Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "https://www.shop4world.com/xbox-one-games/halo-the-master-chief-collection-xbox-one-game",
            "html" : cache.load("https://www.shop4world.com/xbox-one-games/halo-the-master-chief-collection-xbox-one-game")
        }

        it('should return false when product is out of stock', function(done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Halo the Master Chief Collection Xbox One Game",
                    "price": "",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "country": "uk",
                    "description": ""
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        })

    });


    describe('Out of Stock Page (Last one)', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.shop4world.com/animated-films-blu-ray/rise-of-the-guardians-triple-play-blu-ray-plus-dvd-plus-digital-copy?utm_source=affiliatewindow&utm_medium=shopping&utm_campaign=affiliate+window+shopping+data+feed+(16/08/2016)",
            "html" : cache.load("http://www.shop4world.com/animated-films-blu-ray/rise-of-the-guardians-triple-play-blu-ray-plus-dvd-plus-digital-copy?utm_source=affiliatewindow&utm_medium=shopping&utm_campaign=affiliate+window+shopping+data+feed+(16/08/2016)")
        }

        it('should return false when product is out of stock', function(done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Rise of the Guardians Triple Play Blu-ray + DVD + Digital Copy",
                    "price": "3.95",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": "http://img.shop4world.com/dvd_and_bluray/bluray/films/animation/rise_of_the_guardians_triple_play_bluray__dvd__digital_copy_raw.jpg",
                    "country": "uk",
                    "description": "Please note this is a region B Blu-Ray and will require a region B or region free Blu-Ray player in order to playSpecial Features:Filmmakers' Commentary by Director Peter Ramsey and Producers Christina Steinberg and Nancy BernsteinBlu-ray Exclusives: Jack Frost Snowball Showdown! (Game) / Rock, Paper, Scissors with Sandy (Game)Behind the Magic / The Man Behind the Guardians / Dreamers and BelieversPreviews: The Croods / Dreamworks Dragons: Riders of Berk / Kung Fu Panda: Legends of Awesomeness / Rise of the Guardians: The Video GameWorld of Dreamworks Animation: Shrek / Madagascar / How To Train Your Dragon / Kung Fu PandaAge Rating PGÂ "
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        })

    });

    describe('Out of Stock Page (currently unavailable)', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.shop4world.com/comedy-films-dvd/the-front-dvd?utm_source=affiliatewindow&utm_medium=shopping&utm_campaign=affiliate+window+shopping+data+feed+(28/09/2016)",
            "html" : cache.load("http://www.shop4world.com/comedy-films-dvd/the-front-dvd?utm_source=affiliatewindow&utm_medium=shopping&utm_campaign=affiliate+window+shopping+data+feed+(28/09/2016)")
        }

        it('should return false when product is out of stock', function(done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "The Front DVD",
                    "price": "",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": "http://img.shop4world.com/dvd_and_bluray/dvd/the_front_xl.jpg",
                    "country": "uk",
                    "description": "Please note this is a region 2 DVD and will require a region 2 or region free DVD player in order to play.A cashier poses as a writer for blacklisted talents to submit their work through, but the injustice around him pushes him to take a stand."
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        })

    });
    // describe('Limited Stock Page', function() {

    //     var payload = {
    //         "pageType" : "product",
    //         "url" : "http://www.shop4world.com/childrens-card-games/the-gruffalo-mini-memory-game"
    //     }

    //     it('should return false when product has limited stock', function(done) {

    //         Structure(payload, function(inStockPage) {
    //             var expected = JSON.stringify({
    //                 "name": "The Gruffalo Mini Memory Game",
    //                 "price": "4.45",
    //                 "url": null,
    //                 "inStock": false,
    //                 "stockLevel": null,
    //                 "image": "",
    //                 "country": "uk"
    //             })
    //             JSON.stringify(inStockPage).should.equal(expected);
    //             done()
    //         })
    //     })

    // });

    describe('Pre-Order Stock Page', function() {

        var payload = {
            "pageType" : "product",
            "url" : "http://www.shop4world.com/classic-board-games/candy-crush-soda-saga-monopoly",
            "html" : cache.load("http://www.shop4world.com/classic-board-games/candy-crush-soda-saga-monopoly")
        }

        it('should return false when product is pre-order only stock', function(done) {

            Structure(payload, function(err, inStockPage) {
                var expected = JSON.stringify({
                    "name": "Candy Crush Soda Saga Monopoly",
                    "price": "25.94",
                    "url": payload.url,
                    "inStock": false,
                    "stockLevel": null,
                    "image": "http://img.shop4world.com/board_games/classic/candy_crush_soda_saga_monopoly_1_raw.jpg",
                    "country": "uk",
                    "description": "Special Edition Candy Crush Saga monopoly based on the upcoming film. Description currently unavailable, will be edited and uploaded shortly.Monopoly is the fast-dealing property trading game that will have the whole family buying, selling, trading and having fun.For 2 to 6 players.Ages 8 and up"
                })
                JSON.stringify(inStockPage).should.equal(expected);
                done()
            })
        })

    });

 describe('Search page pagination', function() {
        var payload = {
            "pageType" : "pagination",
            "url" : "http://www.shop4world.com/headphones",
            "html" : cache.load("http://www.shop4world.com/headphones")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, pagination) {
                var expected = JSON.stringify({
                    "items": 100,
                    "pages": 13,
                    "url":"http://www.shop4world.com/headphones"
                })
                JSON.stringify(pagination).should.equal(expected);
                done()
            })
        });

    })

    describe('Search page category', function() {

        var payload = {
            "pageType" : "category",
            "url" : "http://www.shop4world.com/headphones",
            "html" : cache.load("http://www.shop4world.com/headphones")
        }

        it('should be true when number of items and pages correct', function (done) {

            Structure(payload, function(err, category) {
                var expected = JSON.stringify({
                    "name": "Headphones and Earphones",
                    "url":"http://www.shop4world.com/headphones"
                })
                JSON.stringify(category).should.equal(expected);
                done()
            })
        });

    });

    describe('Search Page', function() {

        var payload = {
            "pageType" : "search",
            "url" : "https://www.shop4world.com/arts-and-crafts",
            "html" : cache.load("https://www.shop4world.com/arts-and-crafts")
        }

        // Change to be the number of products on the page
        var x = 60;
        it('should return ' + x + ' numer of products', function (done) {
            Structure(payload, function(err, result) {
                result.length.should.equal(x);
                done()
            })
        });

        var firstProductName = 'Billing Boats 1:100 Bluenose II';
        it('first product should be ' + firstProductName, function(done) {
            Structure(payload, function(err, result) {
                var first = result.shift()
                var expected = JSON.stringify({
                    barcode: null,
                    name: firstProductName,
                    price: '79.99',
                    url: 'https://www.shop4world.com/craft-model-kits/billing-boats-1100-bluenose-ii',
                    image: 'https://d8mkdcmng3.imgix.net/709b/toys-and-games-arts-and-crafts-model-kits-billing-boats-1100-bluenose-ii.jpg?h=176&q=90&w=176&s=c6cf541bb6b2799bff8384dac6150b97',
                    country: 'uk'
                })
                JSON.stringify(first).should.equal(expected)
                done()
            })

        })

        var lastProductName = 'Hasegawa 1:72 SD.KFZ 251:9 Stummel';
        it('last product should be ' + lastProductName, function (done) {
            Structure(payload, function(err, result) {
                var last = result.pop()
                var expected = JSON.stringify({
                    barcode: null,
                    name: lastProductName,
                    price: '12.99',
                    url: 'https://www.shop4world.com/craft-model-kits/hasegawa-172-sd-kfz-2519-stummel',
                    image: 'https://d8mkdcmng3.imgix.net/d0b4/toys-and-games-arts-and-crafts-model-kits-hasegawa-172-sdkfz-2519-stummel.jpg?h=176&q=90&w=176&s=028b0c2abadd496c3f3e44c9bccb8d81',
                    country: 'uk'
                })

                JSON.stringify(last).should.equal(expected)
                done()
            });
        })

    });

});

